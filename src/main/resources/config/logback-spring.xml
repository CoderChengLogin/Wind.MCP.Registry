<?xml version="1.0" encoding="UTF-8"?>
<!--
    Logback配置文件
    适配Spring Boot 3.x
    项目: Wind MCP Registry
    更新日期: 2025-10-15
-->
<configuration scan="true" scanPeriod="60 seconds">

    <!-- ==================== 上下文名称 ==================== -->
    <contextName>wind-mcp-registry</contextName>

    <!-- ==================== 引入Spring Boot默认配置 ==================== -->
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>

    <!-- ==================== 属性配置 ==================== -->
    <!-- 应用名称 -->
    <springProperty scope="context" name="APP_NAME" source="spring.application.name" defaultValue="wind-mcp-registry"/>

    <!-- 日志存储路径 - 优先使用Spring配置,否则使用默认值 -->
    <springProperty scope="context" name="LOG_PATH" source="logging.file.path" defaultValue="./logs"/>

    <!-- 日志文件名前缀 -->
    <property name="LOG_FILE_PREFIX" value="${APP_NAME}"/>

    <!-- ==================== 日志格式配置 ==================== -->
    <!-- 控制台日志格式 - 带颜色,使用完整类名 -->
    <property name="CONSOLE_LOG_PATTERN"
              value="%clr(%d{yyyy-MM-dd HH:mm:ss.SSS}){faint} %clr(${LOG_LEVEL_PATTERN:-%5p}) %clr([%15.15t]){faint} %clr(%logger){cyan} %clr(:){faint} %m%n${LOG_EXCEPTION_CONVERSION_WORD:-%wEx}"/>

    <!-- 文件日志格式 - 不带颜色,使用完整类名 -->
    <property name="FILE_LOG_PATTERN"
              value="%d{yyyy-MM-dd HH:mm:ss.SSS} ${LOG_LEVEL_PATTERN:-%5p} [%t] %logger : %m%n${LOG_EXCEPTION_CONVERSION_WORD:-%wEx}"/>

    <!-- ==================== 控制台输出 Appender ==================== -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <!-- 日志级别过滤器 - 只输出INFO及以上级别 -->
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
            <level>INFO</level>
        </filter>
        <encoder>
            <pattern>${CONSOLE_LOG_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>

    <!-- ==================== 文件输出 Appender - 所有日志 ==================== -->
    <appender name="FILE_ALL" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <!-- 当前日志文件 -->
        <file>${LOG_PATH}/${LOG_FILE_PREFIX}.log</file>

        <!-- 滚动策略 -->
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <!-- 归档文件命名模式 -->
            <fileNamePattern>${LOG_PATH}/archive/${LOG_FILE_PREFIX}-%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>

            <!-- 单个文件最大大小 -->
            <maxFileSize>20MB</maxFileSize>

            <!-- 保留天数 -->
            <maxHistory>30</maxHistory>

            <!-- 总大小限制 -->
            <totalSizeCap>2GB</totalSizeCap>

            <!-- 启动时清理 -->
            <cleanHistoryOnStart>false</cleanHistoryOnStart>
        </rollingPolicy>

        <encoder>
            <pattern>${FILE_LOG_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>

    <!-- ==================== 文件输出 Appender - 错误日志 ==================== -->
    <appender name="FILE_ERROR" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <!-- 只记录ERROR级别 -->
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
            <level>ERROR</level>
        </filter>

        <!-- 当前日志文件 -->
        <file>${LOG_PATH}/${LOG_FILE_PREFIX}-error.log</file>

        <!-- 滚动策略 -->
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <!-- 归档文件命名模式 -->
            <fileNamePattern>${LOG_PATH}/archive/${LOG_FILE_PREFIX}-error-%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>

            <!-- 单个文件最大大小 -->
            <maxFileSize>10MB</maxFileSize>

            <!-- 保留天数 -->
            <maxHistory>90</maxHistory>

            <!-- 总大小限制 -->
            <totalSizeCap>1GB</totalSizeCap>

            <!-- 启动时清理 -->
            <cleanHistoryOnStart>false</cleanHistoryOnStart>
        </rollingPolicy>

        <encoder>
            <pattern>${FILE_LOG_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>

    <!-- ==================== 异步日志配置 ==================== -->
    <!-- 异步输出到文件 - 提高性能 -->
    <appender name="ASYNC_FILE" class="ch.qos.logback.classic.AsyncAppender">
        <!-- 不丢失日志。默认如果队列的80%已满,则会丢弃TRACT、DEBUG、INFO级别的日志 -->
        <discardingThreshold>0</discardingThreshold>
        <!-- 队列大小 -->
        <queueSize>512</queueSize>
        <!-- 添加附加的appender,最多只能添加一个 -->
        <appender-ref ref="FILE_ALL"/>
    </appender>

    <appender name="ASYNC_FILE_ERROR" class="ch.qos.logback.classic.AsyncAppender">
        <discardingThreshold>0</discardingThreshold>
        <queueSize>256</queueSize>
        <appender-ref ref="FILE_ERROR"/>
    </appender>

    <!-- ==================== Logger配置 ==================== -->

    <!-- Spring框架日志 -->
    <logger name="org.springframework" level="INFO"/>
    <logger name="org.springframework.web" level="INFO"/>
    <logger name="org.springframework.boot" level="INFO"/>

    <!-- MyBatis Plus日志 -->
    <logger name="com.baomidou.mybatisplus" level="INFO"/>

    <!-- 数据库SQL日志 - 开发环境可以设置为DEBUG查看SQL -->
    <logger name="cn.com.wind.mcp.registry.mapper" level="DEBUG"/>

    <!-- Tomcat日志 -->
    <logger name="org.apache.catalina" level="INFO"/>
    <logger name="org.apache.tomcat" level="INFO"/>

    <!-- Hibernate Validator -->
    <logger name="org.hibernate.validator" level="WARN"/>

    <!-- 项目日志 - 可以根据环境调整 -->
    <logger name="cn.com.wind.mcp.registry" level="DEBUG" additivity="false">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="ASYNC_FILE"/>
        <appender-ref ref="ASYNC_FILE_ERROR"/>
    </logger>

    <!-- ==================== 根Logger配置 ==================== -->
    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="ASYNC_FILE"/>
        <appender-ref ref="ASYNC_FILE_ERROR"/>
    </root>

    <!-- ==================== 环境特定配置 ==================== -->

    <!-- 开发环境 -->
    <springProfile name="dev">
        <logger name="cn.com.wind.mcp.registry" level="DEBUG"/>
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>

    <!-- 测试环境 -->
    <springProfile name="test">
        <logger name="cn.com.wind.mcp.registry" level="INFO"/>
    </springProfile>

    <!-- 生产环境 -->
    <springProfile name="prod">
        <logger name="cn.com.wind.mcp.registry" level="INFO"/>
        <!-- 生产环境关闭SQL日志 -->
        <logger name="cn.com.wind.mcp.registry.mapper" level="WARN"/>
    </springProfile>

</configuration>
