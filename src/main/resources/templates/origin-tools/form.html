<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title th:text="${tool.id != null ? '编辑工具 - ' + tool.nameDisplay : '添加新工具'} + ' - MCP工具注册中心'">添加新工具
        -
        MCP工具注册中心</title>
    <link href="/vendor/bootstrap/bootstrap-5.3.0.min.css" rel="stylesheet">
    <link href="/vendor/fontawesome/all-6.4.0.min.css" rel="stylesheet">
    <style>
        .navbar-brand {
            font-weight: bold;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .required {
            color: #dc3545;
        }

        .json-editor {
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
<!-- 导航栏 -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="/">
            <i class="fas fa-tools me-2"></i>MCP工具注册中心
        </a>
        <button class="navbar-toggler" data-bs-target="#navbarNav" data-bs-toggle="collapse" type="button">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/">首页</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/mcp-tools">MCP工具</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/origin-http-tools">原始HTTP接口</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <!-- 面包屑导航 -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">首页</a></li>
            <li class="breadcrumb-item"><a href="/origin-http-tools">原始HTTP接口</a></li>
            <li class="breadcrumb-item active" th:text="${tool.id != null ? '编辑工具' : '添加新工具'}">添加新工具</li>
        </ol>
    </nav>

    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="fas fa-globe me-2"></i>
            <span th:text="${tool.id != null ? '编辑工具' : '添加新工具'}">添加新工具</span>
        </h1>
        <a class="btn btn-outline-secondary" href="/origin-http-tools">
            <i class="fas fa-arrow-left me-2"></i>返回列表
        </a>
    </div>

    <!-- 工具表单 -->
    <form id="toolForm" method="post" th:action="@{/origin-http-tools/save}">
        <input th:field="${tool.id}" type="hidden">

        <!-- 基本信息 -->
        <div class="form-section">
            <h4 class="mb-3"><i class="fas fa-info-circle me-2"></i>基本信息</h4>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="name">名称 <span class="required">*</span></label>
                        <input class="form-control" id="name" placeholder="请输入工具名称" required
                               th:field="${tool.nameDisplay}"
                               type="text">
                        <div class="form-text">对应数据库字段：name_display</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="description">功能描述 <span class="required">*</span></label>
                        <textarea class="form-control" id="description" placeholder="请描述这个工具的功能" required
                                  rows="3" th:field="${tool.descDisplay}"></textarea>
                        <div class="form-text">对应数据库字段：desc_display</div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="url">请求url <span class="required">*</span></label>
                        <input class="form-control" id="url" placeholder="https://api.example.com/endpoint" required
                               th:field="${tool.reqUrl}"
                               type="url">
                        <div class="form-text">对应数据库字段：req_url</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="method">请求方式 <span class="required">*</span></label>
                        <select class="form-select" id="method" required th:field="${tool.reqMethod}">
                            <option value="">请选择请求方法</option>
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                            <option value="PUT">PUT</option>
                            <option value="DELETE">DELETE</option>
                            <option value="PATCH">PATCH</option>
                        </select>
                        <div class="form-text">对应数据库字段：req_method</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- HTTP配置 -->
        <div class="form-section">
            <h4 class="mb-3"><i class="fas fa-cog me-2"></i>HTTP配置</h4>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="headers">请求头 <span class="required">*</span></label>
                        <textarea class="form-control json-editor" id="headers"
                                  placeholder='{"Content-Type": "application/json", "Authorization": "Bearer token"}'
                                  required rows="3"
                                  th:field="${tool.reqHeaders}"></textarea>
                        <div class="form-text">对应数据库字段：req_headers</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="inputSchema">输入参数 <span class="required">*</span></label>
                        <textarea class="form-control json-editor" id="inputSchema"
                                  placeholder='{"param1": "value1", "param2": "value2"}'
                                  required rows="3"
                                  th:field="${tool.inputSchema}"></textarea>
                        <div class="form-text">对应数据库字段：input_schema</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 输出参数和服务方配置 -->
        <div class="form-section">
            <h4 class="mb-3"><i class="fas fa-sliders-h me-2"></i>输出参数和服务方配置</h4>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="outputSchema">输出参数 <span class="required">*</span></label>
                        <textarea class="form-control json-editor" id="outputSchema"
                                  placeholder='{"result": "success", "data": {...}}'
                                  required rows="3"
                                  th:field="${tool.outputSchema}"></textarea>
                        <div class="form-text">对应数据库字段：output_schema</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="providerAppNum">服务方app <span class="required">*</span></label>
                        <input class="form-control" id="providerAppNum"
                               placeholder="请输入服务方app名称"
                               required th:field="${tool.providerAppNum}"
                               type="text">
                        <div class="form-text">对应数据库字段：provider_app_num</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 提交按钮 -->
        <div class="d-flex justify-content-end gap-2">
            <a class="btn btn-secondary" href="/origin-http-tools">
                <i class="fas fa-times me-2"></i>取消
            </a>
            <button class="btn btn-info" onclick="testTool()" type="button">
                <i class="fas fa-play me-2"></i>测试工具
            </button>
            <button class="btn btn-success" type="submit">
                <i class="fas fa-save me-2"></i>保存工具
            </button>
        </div>
    </form>
</div>

<script src="/vendor/bootstrap/bootstrap-5.3.0.bundle.min.js"></script>
<script>
    // 表单验证
    document.getElementById('toolForm').addEventListener('submit', function (e) {
        // 验证JSON格式
        const jsonFields = [
            {id: 'headers', name: '请求头'},
            {id: 'inputSchema', name: '输入参数'},
            {id: 'outputSchema', name: '输出参数'}
        ];

        for (let field of jsonFields) {
            const element = document.getElementById(field.id);
            if (element && element.value.trim()) {
                try {
                    JSON.parse(element.value);
                } catch (error) {
                    e.preventDefault();
                    alert(`${field.name} 字段的JSON格式不正确: ${error.message}`);
                    element.focus();
                    return;
                }
            }
        }
    });

    // 测试工具功能
    function testTool() {
        const form = document.getElementById('toolForm');
        const formData = new FormData(form);

        // 这里可以添加测试工具的逻辑
        alert('测试功能开发中...');
    }

    // JSON格式化
    function formatJson(fieldId) {
        const element = document.getElementById(fieldId);
        try {
            const json = JSON.parse(element.value);
            element.value = JSON.stringify(json, null, 2);
        } catch (error) {
            alert('JSON格式不正确: ' + error.message);
        }
    }

    // 为JSON编辑器添加格式化按钮
    document.addEventListener('DOMContentLoaded', function () {
        const jsonEditors = document.querySelectorAll('.json-editor');
        jsonEditors.forEach(editor => {
            editor.addEventListener('blur', function () {
                if (this.value.trim()) {
                    try {
                        const json = JSON.parse(this.value);
                        this.value = JSON.stringify(json, null, 2);
                    } catch (error) {
                        // 静默处理，不打断用户输入
                    }
                }
            });
        });
    });
</script>
</body>
</html>