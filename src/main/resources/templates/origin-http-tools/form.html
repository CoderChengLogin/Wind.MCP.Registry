<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title th:text="${tool.id != null ? '编辑工具 - ' + tool.nameDisplay : '添加新工具'} + ' - MCP工具注册中心'">添加新工具
        - MCP工具注册中心</title>
    <!-- Bootstrap CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="/css/fontawesome-fonts.css" rel="stylesheet">
    <link href="/css/all.min.css" rel="stylesheet">
    <!-- 自定义CSS -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .navbar-brand {
            font-weight: bold;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .required {
            color: #dc3545;
        }

        .json-editor {
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
<!-- 导航栏 -->
<nav th:replace="~{fragments/navigation :: navbar}"></nav>

<div class="container mt-4">
    <!-- 面包屑导航 -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">首页</a></li>
            <li class="breadcrumb-item"><a href="/origin-http-tools">原始HTTP接口</a></li>
            <li class="breadcrumb-item active" th:text="${tool.id != null ? '编辑工具' : '添加新工具'}">添加新工具</li>
        </ol>
    </nav>

    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="fas fa-globe me-2"></i>
            <span th:text="${tool.id != null ? '编辑工具' : '添加新工具'}">添加新工具</span>
        </h1>
        <a class="btn btn-outline-secondary" href="/origin-http-tools">
            <i class="fas fa-arrow-left me-2"></i>返回列表
        </a>
    </div>

    <!-- 工具表单 -->
    <form id="toolForm" method="post" th:action="@{/origin-http-tools/save}">
        <input th:field="${tool.id}" type="hidden">
        <!-- 隐藏字段:保存providerToolNum用于关联MCP工具 -->
        <input th:field="${tool.providerToolNum}" type="hidden">
        <!-- 隐藏字段:保存当前应用名称用于编辑时回显 -->
        <input id="currentAppName" th:value="${providerApp != null ? providerApp.appName : ''}" type="hidden">

        <!-- 基本信息 -->
        <div class="form-section">
            <h4 class="mb-3"><i class="fas fa-info-circle me-2"></i>基本信息</h4>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="nameDisplay">工具名称 <span class="required">*</span></label>
                        <input class="form-control" id="nameDisplay" placeholder="请输入工具名称" required
                               th:field="${tool.nameDisplay}"
                               type="text">
                        <div class="form-text">对应数据库字段:name_display</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="descDisplay">功能描述 <span class="required">*</span></label>
                        <textarea class="form-control" id="descDisplay" placeholder="请描述这个工具的功能" required
                                  rows="3" th:field="${tool.descDisplay}"></textarea>
                        <div class="form-text">对应数据库字段:desc_display</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- HTTP配置 -->
        <div class="form-section">
            <h4 class="mb-3"><i class="fas fa-exchange-alt me-2"></i>HTTP配置</h4>

            <div class="row">
                <div class="col-md-8">
                    <div class="mb-3">
                        <label class="form-label" for="reqUrl">请求URL <span class="required">*</span></label>
                        <input class="form-control" id="reqUrl" placeholder="https://api.example.com/endpoint" required
                               th:field="${tool.reqUrl}"
                               type="url">
                        <div class="form-text">对应数据库字段:req_url</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label" for="reqMethod">请求方法 <span class="required">*</span></label>
                        <select class="form-select" id="reqMethod" required th:field="${tool.reqMethod}">
                            <option value="">请选择</option>
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                            <option value="PUT">PUT</option>
                            <option value="DELETE">DELETE</option>
                            <option value="PATCH">PATCH</option>
                        </select>
                        <div class="form-text">对应数据库字段:req_method</div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div class="mb-3">
                        <label class="form-label" for="reqHeaders">请求头(JSON格式)</label>
                        <textarea class="form-control json-editor" id="reqHeaders"
                                  placeholder='{"Content-Type": "application/json", "Authorization": "Bearer token"}'
                                  rows="4" th:field="${tool.reqHeaders}"></textarea>
                        <div class="form-text">对应数据库字段:req_headers,使用JSON格式</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Schema配置 -->
        <div class="form-section">
            <h4 class="mb-3"><i class="fas fa-file-code me-2"></i>Schema配置</h4>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="inputSchema">输入Schema(JSON Schema格式)</label>
                        <textarea class="form-control json-editor" id="inputSchema"
                                  placeholder='{"type": "object", "properties": {"param1": {"type": "string"}}}'
                                  rows="8" th:field="${tool.inputSchema}"></textarea>
                        <div class="form-text">对应数据库字段:input_schema</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="outputSchema">输出Schema(JSON Schema格式)</label>
                        <textarea class="form-control json-editor" id="outputSchema"
                                  placeholder='{"type": "object", "properties": {"result": {"type": "string"}}}'
                                  rows="8" th:field="${tool.outputSchema}"></textarea>
                        <div class="form-text">对应数据库字段:output_schema</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 提供者配置 -->
        <div class="form-section">
            <h4 class="mb-3"><i class="fas fa-sliders-h me-2"></i>提供者配置</h4>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="providerAppNum">服务方app</label>
                        <select class="form-select" id="providerAppNum" th:field="${tool.providerAppNum}">
                            <option value="">请选择服务方app</option>
                            <!-- 动态加载已注册的应用节点 -->
                        </select>
                        <div class="form-text">只能选择已注册的应用服务节点,对应数据库字段:provider_app_num</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 提交按钮 -->
        <div class="d-flex justify-content-end gap-2 mb-4">
            <a class="btn btn-secondary" href="/origin-http-tools">
                <i class="fas fa-times me-2"></i>取消
            </a>
            <button class="btn btn-primary" type="submit">
                <i class="fas fa-save me-2"></i>保存
            </button>
        </div>
    </form>
</div>

<!-- 页脚 -->
<div th:replace="~{fragments/navigation :: footer}"></div>

<!-- Bootstrap JS -->
<script src="/js/bootstrap.bundle.min.js"></script>
<script>
    /**
     * 加载已注册的应用节点列表
     * 用于填充服务方app下拉选择框
     */
    function loadProviderApps() {
        fetch('/provider-app/listEnabled')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.apps) {
                    const select = document.getElementById('providerAppNum');
                    // 获取当前应用名称(编辑模式时使用)
                    const currentAppName = document.getElementById('currentAppName')?.value;

                    // 清空现有选项(保留第一个"请选择"选项)
                    select.innerHTML = '<option value="">请选择服务方app</option>';

                    // 添加应用节点选项(只显示应用名称,系统会自动负载均衡选择最佳节点)
                    data.apps.forEach(app => {
                        const option = document.createElement('option');
                        option.value = app.id;
                        // 只显示应用名称,不显示具体站点信息
                        option.textContent = app.appName;
                        // 如果需要显示更多信息,可以添加到title属性
                        option.title = `${app.appName} - ${app.siteType || '默认站点'} (${app.appIp}:${app.appPort})`;
                        // 保存应用名称到option的data属性,用于匹配
                        option.dataset.appName = app.appName;
                        select.appendChild(option);
                    });

                    // 如果是编辑模式,根据应用名称匹配选中项
                    if (currentAppName) {
                        // 遍历所有option,找到匹配的应用名称
                        for (let i = 0; i < select.options.length; i++) {
                            const option = select.options[i];
                            if (option.dataset.appName === currentAppName) {
                                select.selectedIndex = i;
                                break;
                            }
                        }
                    }
                } else {
                    console.error('加载应用节点失败:', data.message);
                }
            })
            .catch(error => {
                console.error('加载应用节点时出错:', error);
            });
    }

    // 页面加载完成后加载应用节点列表
    document.addEventListener('DOMContentLoaded', function () {
        loadProviderApps();
    });

    // 表单验证
    document.getElementById('toolForm').addEventListener('submit', function (e) {
        // 验证JSON格式
        const jsonFields = ['reqHeaders', 'inputSchema', 'outputSchema'];
        for (let fieldId of jsonFields) {
            const field = document.getElementById(fieldId);
            if (field.value.trim()) {
                try {
                    JSON.parse(field.value);
                } catch (error) {
                    e.preventDefault();
                    alert(field.previousElementSibling.textContent + ' 不是有效的JSON格式');
                    field.focus();
                    return false;
                }
            }
        }
    });
</script>
</body>
</html>
