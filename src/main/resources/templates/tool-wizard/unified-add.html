<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>一体化工具录入 - MCP工具注册中心</title>

    <!-- Bootstrap CSS -->
    <link href="/vendor/bootstrap/bootstrap-5.1.3.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="/vendor/fontawesome/all-6.0.0.min.css" rel="stylesheet">
    <!-- 自定义CSS -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<!-- 导航栏 -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" th:href="@{/}">
            <i class="fas fa-tools me-2"></i>MCP工具注册中心
        </a>
    </div>
</nav>

<!-- 主要内容区域 -->
<main class="container mt-4">
    <!-- 面包屑导航 -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/}">首页</a></li>
            <li class="breadcrumb-item"><a th:href="@{/tool-wizard}">工具录入向导</a></li>
            <li class="breadcrumb-item active">一体化工具录入</li>
        </ol>
    </nav>

    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">
            <i class="fas fa-magic text-primary me-2"></i>一体化工具录入
        </h1>
        <a class="btn btn-outline-secondary" th:href="@{/tool-wizard}">
            <i class="fas fa-arrow-left me-1"></i>返回向导首页
        </a>
    </div>

    <!-- 步骤指示器 -->
    <div class="step-indicator mb-4">
        <div class="step active" id="step-1">
            <div class="step-number">1</div>
            <span>选择原始工具类型</span>
        </div>
        <i class="fas fa-arrow-right text-muted mx-2"></i>
        <div class="step pending" id="step-2">
            <div class="step-number">2</div>
            <span>填写原始工具信息</span>
        </div>
        <i class="fas fa-arrow-right text-muted mx-2"></i>
        <div class="step pending" id="step-3">
            <div class="step-number">3</div>
            <span>填写MCP工具信息</span>
        </div>
        <i class="fas fa-arrow-right text-muted mx-2"></i>
        <div class="step pending" id="step-4">
            <div class="step-number">4</div>
            <span>配置模板转换器</span>
        </div>
    </div>

    <!-- 表单 -->
    <form id="unifiedForm" method="post" th:action="@{/tool-wizard/save-unified}">

        <!-- 选择的工具类型隐藏字段 -->
        <input id="selectedToolType" name="selectedToolType" type="hidden">
        <!-- 简化流程时用于传递转换器类型 -->
        <input id="skipModeConverterType" type="hidden">

        <!-- ===== 第一部分：选择原始工具类型 ===== -->
        <div class="card mb-4" id="section1">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-list-alt me-2"></i>第一步：选择工具录入模式
                </h5>
                <small>选择您的录入方式：如果已有现成的HTTP/Expo接口，选择完整流程；如果从零开始，可以跳过前两步直接录入MCP工具</small>
            </div>
            <div class="card-body">
                <div class="row justify-content-center">
                    <div class="col-md-10">
                        <div class="mb-4">
                            <label class="form-label">录入模式 <span class="text-danger">*</span></label>
                            <div class="row">
                                <!-- 完整流程 - Expo -->
                                <div class="col-md-3">
                                    <div class="card tool-type-card" data-converter="expo" data-type="expo"
                                         style="cursor: pointer; transition: all 0.3s ease;">
                                        <div class="card-body text-center">
                                            <i class="fas fa-server fa-3x text-primary mb-3"></i>
                                            <h5>Expo工具</h5>
                                            <p class="text-muted mb-2">已有Expo接口工具</p>
                                            <small class="text-info">完整流程(4步)</small>
                                        </div>
                                    </div>
                                </div>
                                <!-- 完整流程 - HTTP -->
                                <div class="col-md-3">
                                    <div class="card tool-type-card" data-converter="http" data-type="http"
                                         style="cursor: pointer; transition: all 0.3s ease;">
                                        <div class="card-body text-center">
                                            <i class="fas fa-globe fa-3x text-success mb-3"></i>
                                            <h5>HTTP工具</h5>
                                            <p class="text-muted mb-2">已有HTTP接口工具</p>
                                            <small class="text-info">完整流程(4步)</small>
                                        </div>
                                    </div>
                                </div>
                                <!-- 简化流程 - HTTP -->
                                <div class="col-md-3">
                                    <div class="card tool-type-card" data-converter="http" data-type="skip-http"
                                         style="cursor: pointer; transition: all 0.3s ease;">
                                        <div class="card-body text-center">
                                            <i class="fas fa-forward fa-3x text-warning mb-3"></i>
                                            <h5>简化流程(HTTP)</h5>
                                            <p class="text-muted mb-2">从零开始,HTTP转换器</p>
                                            <small class="text-warning">仅2步</small>
                                        </div>
                                    </div>
                                </div>
                                <!-- 简化流程 - Expo -->
                                <div class="col-md-3">
                                    <div class="card tool-type-card" data-converter="expo" data-type="skip-expo"
                                         style="cursor: pointer; transition: all 0.3s ease;">
                                        <div class="card-body text-center">
                                            <i class="fas fa-forward fa-3x text-primary mb-3"></i>
                                            <h5>简化流程(Expo)</h5>
                                            <p class="text-muted mb-2">从零开始,Expo转换器</p>
                                            <small class="text-primary">仅2步</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 说明提示 -->
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>流程说明:</strong>
                            <ul class="mb-0 mt-2">
                                <li><strong>完整流程:</strong> 步骤1(选择类型) → 步骤2(原始工具) → 步骤3(MCP工具) →
                                    步骤4(转换模板)
                                </li>
                                <li><strong>简化流程:</strong> 步骤3(MCP工具) → 步骤4(转换模板)，跳过原始工具录入，直接选择转换器类型
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 第一部分完成提示 -->
                <div class="alert alert-success" id="section1-completed" style="display: none;">
                    <i class="fas fa-check-circle me-2"></i>模式选择完成！
                    <span id="mode-message"></span>
                </div>
            </div>
        </div>

        <!-- ===== 第二部分：源工具录入 ===== -->
        <div class="card mb-4 section-locked" id="section2">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-globe me-2"></i>第二步：填写源工具信息
                    <span class="badge bg-warning ms-2" id="section2-lock">
                        <i class="fas fa-lock"></i> 请先选择工具类型
                    </span>
                </h5>
                <small>基于选择的工具类型填写源工具详细信息</small>
            </div>
            <div class="card-body section-content-locked" style="opacity: 0.5; pointer-events: none;">

                <!-- HTTP工具表单 -->
                <div id="http-tool-form" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">名称 <span class="text-danger">*</span></label>
                                <input class="form-control" disabled id="nameDisplay" name="nameDisplay"
                                       placeholder="请输入工具名称"
                                       required type="text">
                                <div class="form-text">对应数据库字段：name_display</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">功能描述 <span class="text-danger">*</span></label>
                                <textarea class="form-control" disabled id="descDisplay" name="descDisplay"
                                          placeholder="请描述这个工具的功能"
                                          required rows="3"></textarea>
                                <div class="form-text">对应数据库字段：desc_display</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">请求url <span class="text-danger">*</span></label>
                                <input class="form-control" disabled id="reqUrl" name="reqUrl"
                                       placeholder="https://api.example.com/endpoint"
                                       required type="url">
                                <div class="form-text">对应数据库字段：req_url</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">请求方式 <span class="text-danger">*</span></label>
                                <select class="form-select" disabled id="reqMethod" name="reqMethod" required>
                                    <option value="">请选择请求方法</option>
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                    <option value="PUT">PUT</option>
                                    <option value="DELETE">DELETE</option>
                                    <option value="PATCH">PATCH</option>
                                </select>
                                <div class="form-text">对应数据库字段：req_method</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">请求头 <span class="text-danger">*</span></label>
                                <textarea class="form-control" disabled id="reqHeaders" name="reqHeaders"
                                          placeholder='{"Content-Type": "application/json", "Authorization": "Bearer token"}'
                                          required rows="3"></textarea>
                                <div class="form-text">对应数据库字段：req_headers</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">输入参数 <span class="text-danger">*</span></label>
                                <textarea class="form-control" disabled id="inputSchema" name="inputSchema"
                                          placeholder='{"param1": "value1", "param2": "value2"}'
                                          required rows="3"></textarea>
                                <div class="form-text">对应数据库字段：input_schema</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">输出参数 <span class="text-danger">*</span></label>
                                <textarea class="form-control" disabled id="outputSchema" name="outputSchema"
                                          placeholder='{"result": "success", "data": {...}}'
                                          required rows="3"></textarea>
                                <div class="form-text">对应数据库字段：output_schema</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">服务方app <span class="text-danger">*</span></label>
                                <select class="form-select" disabled id="providerAppNum" name="providerAppNum" required>
                                    <option value="">请选择服务方app</option>
                                    <!-- 动态加载已注册的应用节点 -->
                                </select>
                                <div class="form-text">只能选择已注册的应用服务节点</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Expo工具表单 -->
                <div id="expo-tool-form" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">工具名称 <span class="text-danger">*</span></label>
                                <input class="form-control" disabled id="expoToolName" name="expoToolName"
                                       placeholder="请输入Expo工具名称"
                                       required type="text">
                                <div class="form-text">工具的标识名称，用于系统识别</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">工具版本 <span class="text-danger">*</span></label>
                                <input class="form-control" disabled id="expoToolVersion" name="expoToolVersion"
                                       placeholder="1.0.0" required type="text">
                                <div class="form-text">工具的版本号</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">应用类别</label>
                                <select class="form-select" disabled id="expoAppClass" name="expoAppClass">
                                    <option value="">请选择应用类别</option>
                                    <option value="1">Web应用</option>
                                    <option value="2">移动应用</option>
                                    <option value="3">桌面应用</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">命令ID</label>
                                <input class="form-control" disabled id="expoCommandId" name="expoCommandId"
                                       placeholder="100" type="number">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label required">工具描述 <span class="text-danger">*</span></label>
                        <textarea class="form-control" disabled id="expoDescription" name="expoDescription"
                                  placeholder="请描述这个Expo工具的功能和用途"
                                  required rows="4"></textarea>
                        <div class="form-text">详细说明工具的功能和使用场景</div>
                    </div>
                </div>

                <!-- 第二部分完成提示 -->
                <div class="alert alert-success" id="section2-completed" style="display: none;">
                    <i class="fas fa-check-circle me-2"></i>源工具信息录入完成！现在可以继续填写MCP工具信息。
                </div>
            </div>
        </div>

        <!-- ===== 第三部分：MCP工具信息 ===== -->
        <div class="card mb-4 section-locked" id="section3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>第三步：填写MCP工具信息
                    <span class="badge bg-warning ms-2" id="section3-lock">
                        <i class="fas fa-lock"></i> 请先完成源工具录入
                    </span>
                </h5>
                <small>基于源工具创建MCP工具信息</small>
            </div>
            <div class="card-body section-content-locked" style="opacity: 0.5; pointer-events: none;">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required">MCP工具英文名 <span class="text-danger">*</span></label>
                            <input class="form-control" disabled id="toolName" name="toolName"
                                   placeholder="请输入MCP工具英文名" required type="text">
                            <div class="form-text">对应数据库字段：tool_name</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required">MCP工具描述 <span class="text-danger">*</span></label>
                            <input class="form-control" disabled id="toolDescription" name="toolDescription"
                                   placeholder="请输入MCP工具描述" required type="text">
                            <div class="form-text">对应数据库字段：tool_description</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required">多语言名称 <span class="text-danger">*</span></label>
                            <input class="form-control" disabled id="mcpNameDisplay" name="mcpNameDisplay"
                                   placeholder="请输入多语言名称" required type="text">
                            <div class="form-text">对应数据库字段：name_display</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required">多语言描述 <span class="text-danger">*</span></label>
                            <input class="form-control" disabled id="descriptionDisplay" name="descriptionDisplay"
                                   placeholder="请输入多语言描述" required type="text">
                            <div class="form-text">对应数据库字段：description_display</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required">input_json_schema <span
                                    class="text-danger">*</span></label>
                            <textarea class="form-control" disabled id="mcpInputSchema" name="mcpInputSchema"
                                      placeholder='请输入JSON Schema格式的输入参数定义'
                                      required rows="3"></textarea>
                            <div class="form-text">对应数据库字段：input_schema</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required">output_json_schema <span
                                    class="text-danger">*</span></label>
                            <textarea class="form-control" disabled id="mcpOutputSchema" name="mcpOutputSchema"
                                      placeholder='请输入JSON Schema格式的输出参数定义'
                                      required rows="3"></textarea>
                            <div class="form-text">对应数据库字段：output_schema</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required">是否流式输出 <span class="text-danger">*</span></label>
                            <select class="form-select" disabled id="streamOutput" name="streamOutput" required>
                                <option value="">请选择是否流式输出</option>
                                <option value="0">否</option>
                                <option value="1">是</option>
                            </select>
                            <div class="form-text">对应数据库字段：stream_output</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required">转换模板类型 <span class="text-danger">*</span></label>
                            <select class="form-select" id="convertType" name="convertType" required>
                                <option value="">请选择转换模板类型</option>
                                <option value="http">HTTP转换模板</option>
                                <option value="expo">Expo转换模板</option>
                                <option value="manual">手动转换模板</option>
                            </select>
                            <div class="form-text">选择工具的转换模板类型</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required">MCP工具类型 <span class="text-danger">*</span></label>
                            <select class="form-select" disabled id="toolType" name="toolType" required>
                                <option value="">请选择MCP工具类型</option>
                                <option value="HTTP工具">HTTP工具</option>
                                <option value="数据库工具">数据库工具</option>
                                <option value="文件工具">文件工具</option>
                                <option value="系统工具">系统工具</option>
                                <option value="网络工具">网络工具</option>
                                <option value="安全工具">安全工具</option>
                                <option value="开发工具">开发工具</option>
                                <option value="监控工具">监控工具</option>
                                <option value="其他">其他</option>
                            </select>
                            <div class="form-text">对应数据库字段：tool_type</div>
                        </div>
                    </div>
                </div>

                <!-- 第二部分完成提示 -->
                <div class="alert alert-success" id="section2-completed" style="display: none;">
                    <i class="fas fa-check-circle me-2"></i>MCP工具信息录入完成！现在可以继续设置转换模板。
                </div>
            </div>
        </div>

        <!-- ===== 第四部分：转换模板设置 ===== -->
        <div class="card mb-4 section-locked" id="section4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-exchange-alt me-2"></i>第四步：配置模板转换器
                    <span class="badge bg-secondary ms-2" id="section4-lock">
                        <i class="fas fa-lock"></i> 请先完成MCP工具信息录入
                    </span>
                </h5>
                <small>设置源工具到MCP工具的转换规则</small>
            </div>
            <div class="card-body section-content-locked" style="opacity: 0.5; pointer-events: none;">

                <!-- HTTP模板转换器表单 -->
                <div id="http-converter-form" style="display: none;">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>HTTP模板转换器配置
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">请求路径 <span class="text-danger">*</span></label>
                                <input class="form-control" disabled id="templateReqUrl" name="templateReqUrl"
                                       placeholder="请输入请求路径" type="text">
                                <div class="form-text">对应数据库字段：req_url</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">请求方式 <span class="text-danger">*</span></label>
                                <select class="form-select" disabled id="templateReqMethod" name="templateReqMethod">
                                    <option value="">请选择请求方式</option>
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                    <option value="PUT">PUT</option>
                                    <option value="DELETE">DELETE</option>
                                    <option value="PATCH">PATCH</option>
                                </select>
                                <div class="form-text">对应数据库字段：req_method</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label required">请求头（jinja2） <span class="text-danger">*</span></label>
                        <textarea class="form-control" disabled id="templateReqHeaders" name="templateReqHeaders"
                                  placeholder='请输入jinja2格式的请求头模板' rows="3"></textarea>
                        <div class="form-text">对应数据库字段：req_headers</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label required">请求体（jinja2） <span class="text-danger">*</span></label>
                        <textarea class="form-control" disabled id="reqBody" name="reqBody"
                                  placeholder='请输入jinja2格式的请求体模板' rows="5"></textarea>
                        <div class="form-text">对应数据库字段：req_body</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label required">响应体（jinja2） <span class="text-danger">*</span></label>
                        <textarea class="form-control" disabled id="respBody" name="respBody"
                                  placeholder='请输入jinja2格式的响应体模板' rows="5"></textarea>
                        <div class="form-text">对应数据库字段：resp_body</div>
                    </div>
                </div>

                <!-- Expo模板转换器表单 -->
                <div id="expo-converter-form" style="display: none;">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>Expo模板转换器配置
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">App Class <span class="text-danger">*</span></label>
                                <input class="form-control" disabled id="templateAppClass" name="templateAppClass"
                                       placeholder="请输入App Class" type="number">
                                <div class="form-text">对应数据库字段：app_class</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">Command ID <span class="text-danger">*</span></label>
                                <input class="form-control" disabled id="templateCommandId" name="templateCommandId"
                                       placeholder="请输入Command ID" type="number">
                                <div class="form-text">对应数据库字段：command_id</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label required">输入参数（jinja2） <span class="text-danger">*</span></label>
                        <textarea class="form-control" disabled id="templateInputArgs" name="templateInputArgs"
                                  placeholder='请输入jinja2格式的输入参数模板' rows="5"></textarea>
                        <div class="form-text">对应数据库字段：input_args</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label required">输出参数（jinja2） <span class="text-danger">*</span></label>
                        <textarea class="form-control" disabled id="templateOutputArgs" name="templateOutputArgs"
                                  placeholder='请输入jinja2格式的输出参数模板' rows="5"></textarea>
                        <div class="form-text">对应数据库字段：output_args</div>
                    </div>
                </div>

                <!-- 第四部分完成提示 -->
                <div class="alert alert-success" id="section4-completed" style="display: none;">
                    <i class="fas fa-check-circle me-2"></i>转换模板设置完成！所有信息已录入完整，可以保存了。
                </div>
            </div>
        </div>

        <!-- 保存按钮 -->
        <div class="card">
            <div class="card-body text-center">
                <button class="btn btn-success btn-lg" disabled id="saveBtn" type="submit">
                    <i class="fas fa-save me-2"></i>一键保存工具信息
                </button>
                <div class="form-text mt-2">
                    <i class="fas fa-info-circle me-1"></i>
                    请完成所有必填项后才能保存
                </div>
            </div>
        </div>
    </form>
</main>

<!-- 页脚 -->
<footer class="bg-light mt-5 py-4">
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <h5>MCP工具注册中心</h5>
                <p class="text-muted">统一管理和注册MCP工具的平台</p>
            </div>
            <div class="col-md-6 text-md-end">
                <p class="text-muted">
                    &copy; 2024 MCP工具注册中心. All rights reserved.
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- Bootstrap JS -->
<script src="/vendor/bootstrap/bootstrap-5.1.3.bundle.min.js"></script>
<!-- 自定义JS -->
<script th:src="@{/js/app.js}"></script>

<!-- 页面专用样式 -->
<style>
    .step-indicator {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 2rem;
    }

    .step {
        display: flex;
        align-items: center;
        margin: 0 1rem;
    }

    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 0.5rem;
    }

    .step.active .step-number {
        background: #0d6efd;
        color: white;
    }

    .step.completed .step-number {
        background: #198754;
        color: white;
    }

    .step.pending .step-number {
        background: #6c757d;
        color: white;
    }

    .section-locked .card-header {
        opacity: 0.7;
    }

    .required {
        font-weight: 600;
    }

    .form-control:focus {
        border-color: #198754;
        box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
    }

    .section-content-locked {
        transition: all 0.3s ease;
    }

    .alert {
        border: none;
        border-radius: 10px;
    }

    #saveBtn {
        min-width: 250px;
        padding: 12px 30px;
        font-size: 16px;
        font-weight: 600;
    }
</style>

<!-- 页面专用JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 必填字段配置
        const requiredFields = {
            section1: [], // 第一步只需要选择工具类型，通过点击事件验证
            section2: [], // 动态设置，根据选择的工具类型
            section3: ['toolName', 'toolDescription', 'mcpNameDisplay', 'descriptionDisplay', 'mcpInputSchema', 'mcpOutputSchema', 'streamOutput', 'convertType', 'toolType'],
            section4: [] // 动态设置，根据选择的转换器类型
        };

        let selectedToolType = '';
        let selectedConverterType = ''; // 用于跟踪选中的转换器类型

        /**
         * 加载已注册的应用节点列表
         * 用于填充服务方app下拉选择框
         */
        function loadProviderApps() {
            fetch('/provider-app/listEnabled')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.apps) {
                        const select = document.getElementById('providerAppNum');
                        // 清空现有选项(保留第一个"请选择"选项)
                        select.innerHTML = '<option value="">请选择服务方app</option>';

                        // 添加应用节点选项
                        data.apps.forEach(app => {
                            const option = document.createElement('option');
                            option.value = app.appName;
                            option.textContent = `${app.appName} (${app.appIp}:${app.appPort})`;
                            select.appendChild(option);
                        });
                    } else {
                        console.warn('未能加载应用节点列表:', data.message);
                    }
                })
                .catch(error => {
                    console.error('加载应用节点列表失败:', error);
                });
        }

        // 页面加载时立即加载应用列表
        loadProviderApps();

        /**
         * 显示对应类型的模板转换器表单
         * @param {string} converterType - 转换器类型 ('http' 或 'expo')
         */
        function showConverterForm(converterType) {
            selectedConverterType = converterType;

            // 隐藏所有转换器表单
            document.getElementById('http-converter-form').style.display = 'none';
            document.getElementById('expo-converter-form').style.display = 'none';

            // 显示对应的转换器表单
            if (converterType === 'http') {
                document.getElementById('http-converter-form').style.display = 'block';
                // 设置HTTP转换器的必填字段
                requiredFields.section4 = ['templateReqUrl', 'templateReqMethod', 'templateReqHeaders', 'reqBody', 'respBody'];
            } else if (converterType === 'expo') {
                document.getElementById('expo-converter-form').style.display = 'block';
                // 设置Expo转换器的必填字段
                requiredFields.section4 = ['templateAppClass', 'templateCommandId', 'templateInputArgs', 'templateOutputArgs'];
            }
        }

        // 工具类型卡片点击事件
        document.querySelectorAll('.tool-type-card').forEach(card => {
            card.addEventListener('click', function () {
                // 移除其他卡片的选中状态
                document.querySelectorAll('.tool-type-card').forEach(c => {
                    c.classList.remove('border-primary');
                    c.style.borderWidth = '1px';
                });

                // 添加选中状态
                this.classList.add('border-primary');
                this.style.borderWidth = '3px';

                // 设置选中的工具类型
                selectedToolType = this.dataset.type;
                document.getElementById('selectedToolType').value = selectedToolType;

                // 设置转换器类型
                const converterType = this.dataset.converter;

                // 根据模式设置提示信息
                const modeMessage = document.getElementById('mode-message');

                // 判断是否为简化流程
                const isSkipMode = selectedToolType.startsWith('skip-');

                if (isSkipMode) {
                    // 简化流程：直接跳到步骤3
                    const converterName = converterType === 'http' ? 'HTTP' : 'Expo';
                    modeMessage.textContent = `您选择了简化流程(${converterName})，将直接进入步骤3(MCP工具录入)。`;
                    requiredFields.section2 = []; // 第二步不需要必填字段

                    // 隐藏步骤2
                    document.getElementById('section2').style.display = 'none';
                    document.getElementById('step-2').style.display = 'none';
                    document.querySelectorAll('.fa-arrow-right')[0].style.display = 'none';

                    // 显示对应类型的第4步模板转换器表单
                    showConverterForm(converterType);

                    // 在简化流程中,自动设置convertType字段为转换器类型
                    // 这样后端的determineConverterType方法就能正确识别
                    document.getElementById('skipModeConverterType').value = converterType;
                    const convertTypeField = document.getElementById('convertType');
                    if (convertTypeField) {
                        convertTypeField.value = converterType;
                        // 触发input事件,让表单验证能够感知到这个变化
                        convertTypeField.dispatchEvent(new Event('input', {bubbles: true}));
                    }

                    // 设置selectedToolType为'skip',告诉后端这是简化流程
                    document.getElementById('selectedToolType').value = 'skip';

                    // 直接解锁步骤3
                    setTimeout(() => {
                        unlockSection(3);
                        document.getElementById('step-3').classList.add('active');
                        document.getElementById('step-3').classList.remove('pending');
                    }, 500);
                } else {
                    // 完整流程
                    modeMessage.textContent = '现在可以继续填写' + (selectedToolType === 'http' ? 'HTTP' : 'Expo') + '工具信息。';

                    // 显示步骤2
                    document.getElementById('section2').style.display = 'block';
                    document.getElementById('step-2').style.display = 'flex';
                    document.querySelectorAll('.fa-arrow-right')[0].style.display = 'inline';

                    // 显示对应类型的第4步模板转换器表单
                    showConverterForm(converterType);

                    // 设置第二步的必填字段
                    if (selectedToolType === 'http') {
                        requiredFields.section2 = ['nameDisplay', 'descDisplay', 'reqUrl', 'reqMethod', 'reqHeaders', 'inputSchema', 'outputSchema', 'providerAppNum'];
                    } else if (selectedToolType === 'expo') {
                        requiredFields.section2 = ['expoToolName', 'expoToolVersion', 'expoDescription'];
                    }

                    // 解锁下一步
                    unlockNextSection(1);
                }

                // 显示完成提示
                document.getElementById('section1-completed').style.display = 'block';
            });
        });

        // 检查每个部分的完成状态
        function checkSectionCompletion(sectionId) {
            if (sectionId === 'section1') {
                return selectedToolType !== '';
            }
            const fields = requiredFields[sectionId];
            return fields.every(fieldId => {
                const field = document.getElementById(fieldId);
                return field && field.value.trim() !== '';
            });
        }

        // 解锁指定的部分(用于跳过模式)
        function unlockSection(sectionNumber) {
            const sectionElement = document.getElementById(`section${sectionNumber}`);
            const lockElement = document.getElementById(`section${sectionNumber}-lock`);
            const contentElement = sectionElement.querySelector('.section-content-locked');

            // 移除锁定状态
            sectionElement.classList.remove('section-locked');
            if (lockElement) lockElement.style.display = 'none';
            contentElement.style.opacity = '1';
            contentElement.style.pointerEvents = 'auto';

            // 启用所有字段
            const allInputs = sectionElement.querySelectorAll('input, textarea, select');
            allInputs.forEach(input => input.disabled = false);

            // 平滑滚动到该部分
            sectionElement.scrollIntoView({behavior: 'smooth', block: 'start'});
        }

        // 解锁下一个部分
        function unlockNextSection(currentSection) {
            const nextSection = currentSection + 1;
            if (nextSection <= 4) {
                const nextSectionElement = document.getElementById(`section${nextSection}`);
                const nextLockElement = document.getElementById(`section${nextSection}-lock`);
                const nextContentElement = nextSectionElement.querySelector('.section-content-locked');
                const nextIndicator = document.getElementById(`step${nextSection}-indicator`);

                // 移除锁定状态
                nextSectionElement.classList.remove('section-locked');
                nextLockElement.style.display = 'none';
                nextContentElement.style.opacity = '1';
                nextContentElement.style.pointerEvents = 'auto';

                // 根据选择的工具类型显示对应的表单
                if (nextSection === 2) {
                    if (selectedToolType === 'http') {
                        document.getElementById('http-tool-form').style.display = 'block';
                        document.getElementById('expo-tool-form').style.display = 'none';
                    } else if (selectedToolType === 'expo') {
                        document.getElementById('http-tool-form').style.display = 'none';
                        document.getElementById('expo-tool-form').style.display = 'block';
                    }
                }

                // 启用字段
                const fields = requiredFields[`section${nextSection}`];
                fields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) field.disabled = false;
                });

                // 启用其他字段
                const allInputs = nextSectionElement.querySelectorAll('input, textarea, select');
                allInputs.forEach(input => input.disabled = false);

                // 更新进度指示器
                nextIndicator.classList.remove('pending');
                nextIndicator.classList.add('active');

                // 显示完成提示
                const completedAlert = document.getElementById(`section${currentSection}-completed`);
                if (completedAlert) {
                    completedAlert.style.display = 'block';
                }

                // 平滑滚动到下一部分
                nextSectionElement.scrollIntoView({behavior: 'smooth', block: 'start'});
            }
        }

        // 检查是否可以启用保存按钮
        function checkSaveButton() {
            const allCompleted = Object.keys(requiredFields).every(section => checkSectionCompletion(section));
            const saveBtn = document.getElementById('saveBtn');

            if (allCompleted) {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>一键保存工具信息';

                // 显示最终完成提示
                const section4Completed = document.getElementById('section4-completed');
                if (section4Completed) {
                    section4Completed.style.display = 'block';
                }

                // 更新所有进度指示器为完成状态
                for (let i = 1; i <= 4; i++) {
                    const indicator = document.getElementById(`step-${i}`);
                    indicator.classList.add('completed');
                    indicator.classList.remove('active');
                    indicator.classList.remove('pending');
                }
            } else {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-lock me-2"></i>请完成所有必填项';
            }
        }

        // 为所有输入字段添加事件监听器
        const allInputs = document.querySelectorAll('input, textarea, select');
        allInputs.forEach(input => {
            input.addEventListener('input', function () {
                // 检查当前字段所属的部分
                let currentSection = 1;
                if (this.name === 'nameDisplay' || this.name === 'descDisplay' || this.name === 'reqUrl' ||
                    this.name === 'reqMethod' || this.name === 'reqHeaders' || this.name === 'inputSchema' ||
                    this.name === 'outputSchema' || this.name === 'providerAppNum' ||
                    this.name.startsWith('expo')) currentSection = 2;
                else if (this.name === 'toolName' || this.name === 'toolDescription' ||
                    this.name === 'mcpNameDisplay' || this.name === 'descriptionDisplay' ||
                    this.name === 'mcpInputSchema' || this.name === 'mcpOutputSchema' ||
                    this.name === 'streamOutput' || this.name === 'convertType' || this.name === 'toolType') currentSection = 3;
                else if (this.name === 'templateReqUrl' || this.name === 'templateReqMethod' ||
                    this.name === 'templateReqHeaders' || this.name === 'reqBody' || this.name === 'respBody' ||
                    this.name === 'templateAppClass' || this.name === 'templateCommandId' ||
                    this.name === 'templateInputArgs' || this.name === 'templateOutputArgs') currentSection = 4;

                // 检查当前部分是否完成
                if (checkSectionCompletion(`section${currentSection}`)) {
                    // 如果当前部分完成，解锁下一部分
                    if (currentSection < 4) {
                        unlockNextSection(currentSection);
                    }

                    // 检查是否可以启用保存按钮
                    checkSaveButton();
                }
            });
        });

        // 表单提交处理
        document.getElementById('unifiedForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            // 显示保存中状态
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>保存中...';

            // 发送数据到后端
            fetch(this.action, {
                method: 'POST',
                body: formData
            })
                .then(response => response.text())
                .then(result => {
                    if (result === 'success') {
                        saveBtn.innerHTML = '<i class="fas fa-check me-2"></i>保存成功！';
                        saveBtn.classList.remove('btn-success');
                        saveBtn.classList.add('btn-outline-success');

                        // 显示成功提示
                        const alert = document.createElement('div');
                        alert.className = 'alert alert-success alert-dismissible fade show';
                        alert.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>保存成功！</strong> 工具信息已成功录入系统,即将跳转到MCP工具列表页面...
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                        document.querySelector('main').insertBefore(alert, document.querySelector('main').firstChild);

                        // 1.5秒后跳转到MCP工具列表页
                        setTimeout(() => {
                            window.location.href = '/mcp-tools';
                        }, 1500);
                    } else {
                        // 处理错误响应(格式: "error:错误信息")
                        let errorMessage = '保存失败';
                        if (result.startsWith('error:')) {
                            errorMessage = result.substring(6); // 移除"error:"前缀
                        }
                        throw new Error(errorMessage);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);

                    // 恢复按钮状态
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>一键保存工具信息';
                    saveBtn.classList.remove('btn-danger');
                    saveBtn.classList.add('btn-success');

                    // 显示错误提示
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-danger alert-dismissible fade show';
                    alert.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>保存失败！</strong> ${error.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                    document.querySelector('main').insertBefore(alert, document.querySelector('main').firstChild);

                    // 滚动到顶部以显示错误提示
                    window.scrollTo({top: 0, behavior: 'smooth'});
                });
        });
    });
</script>
</body>
</html>