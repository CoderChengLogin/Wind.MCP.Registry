<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>一体化工具录入 - MCP工具注册中心</title>

    <!-- Bootstrap CSS -->
    <link href="/vendor/bootstrap/bootstrap-5.1.3.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="/vendor/fontawesome/all-6.0.0.min.css" rel="stylesheet">
    <!-- 自定义CSS -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<!-- 导航栏 -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" th:href="@{/}">
            <i class="fas fa-tools me-2"></i>MCP工具注册中心
        </a>
    </div>
</nav>

<!-- 主要内容区域 -->
<main class="container mt-4">
    <!-- 消息提示区域 -->
    <div class="mb-4" id="messageContainer" style="display: none;"></div>

    <!-- 面包屑导航 -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/}">首页</a></li>
            <li class="breadcrumb-item"><a th:href="@{/tool-wizard}">工具录入向导</a></li>
            <li class="breadcrumb-item active">一体化工具录入</li>
        </ol>
    </nav>

    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">
            <i class="fas fa-magic text-primary me-2"></i>一体化工具录入
        </h1>
        <a class="btn btn-outline-secondary" th:href="@{/tool-wizard}">
            <i class="fas fa-arrow-left me-1"></i>返回向导首页
        </a>
    </div>

    <!-- 步骤指示器 -->
    <div class="step-indicator mb-4">
        <div class="step active" id="step-1">
            <div class="step-number">1</div>
            <span>选择原始工具类型</span>
        </div>
        <i class="fas fa-arrow-right text-muted mx-2"></i>
        <div class="step pending" id="step-2">
            <div class="step-number">2</div>
            <span>填写原始工具信息</span>
        </div>
        <i class="fas fa-arrow-right text-muted mx-2"></i>
        <div class="step pending" id="step-3">
            <div class="step-number">3</div>
            <span>填写MCP工具信息</span>
        </div>
        <i class="fas fa-arrow-right text-muted mx-2"></i>
        <div class="step pending" id="step-4">
            <div class="step-number">4</div>
            <span>配置模板转换器</span>
        </div>
    </div>

    <!-- 表单 -->
    <form id="unifiedForm" method="post" th:action="@{/tool-wizard/save-unified}">

        <!-- 选择的工具类型隐藏字段 -->
        <input id="selectedToolType" name="selectedToolType" type="hidden">

        <!-- ===== 第一部分：选择原始工具类型 ===== -->
        <div class="card mb-4" id="section1">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-list-alt me-2"></i>第一步：选择原始工具类型
                </h5>
                <small>首先选择您要录入的原始工具类型，支持HTTP工具和Expo工具</small>
            </div>
            <div class="card-body">
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="mb-4">
                            <label class="form-label">工具类型 <span class="text-danger">*</span></label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card tool-type-card" data-type="expo"
                                         style="cursor: pointer; transition: all 0.3s ease;">
                                        <div class="card-body text-center">
                                            <i class="fas fa-server fa-3x text-primary mb-3"></i>
                                            <h5>Expo工具</h5>
                                            <p class="text-muted">基于Expo协议的工具</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card tool-type-card" data-type="http"
                                         style="cursor: pointer; transition: all 0.3s ease;">
                                        <div class="card-body text-center">
                                            <i class="fas fa-globe fa-3x text-success mb-3"></i>
                                            <h5>HTTP工具</h5>
                                            <p class="text-muted">基于HTTP协议的Web API工具</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 第一部分完成提示 -->
                <div class="alert alert-success" id="section1-completed" style="display: none;">
                    <i class="fas fa-check-circle me-2"></i>工具类型选择完成！现在可以继续填写源工具信息。
                </div>
            </div>
        </div>

        <!-- ===== 第二部分：源工具录入 ===== -->
        <div class="card mb-4 section-locked" id="section2">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-globe me-2"></i>第二步：填写源工具信息
                    <span class="badge bg-warning ms-2" id="section2-lock">
                        <i class="fas fa-lock"></i> 请先选择工具类型
                    </span>
                </h5>
                <small>基于选择的工具类型填写源工具详细信息</small>
            </div>
            <div class="card-body section-content-locked" style="opacity: 0.5; pointer-events: none;">

                <!-- HTTP工具表单 -->
                <div id="http-tool-form" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">名称 <span class="text-danger">*</span></label>
                                <input class="form-control" disabled id="nameDisplay" name="nameDisplay"
                                       placeholder="请输入工具名称"
                                       required type="text">
                                <div class="form-text">对应数据库字段：name_display</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">功能描述 <span class="text-danger">*</span></label>
                                <textarea class="form-control" disabled id="descDisplay" name="descDisplay"
                                          placeholder="请描述这个工具的功能"
                                          required rows="3"></textarea>
                                <div class="form-text">对应数据库字段：desc_display</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">请求url <span class="text-danger">*</span></label>
                                <input class="form-control" disabled id="reqUrl" name="reqUrl"
                                       placeholder="https://api.example.com/endpoint"
                                       required type="url">
                                <div class="form-text">对应数据库字段：req_url</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">请求方式 <span class="text-danger">*</span></label>
                                <select class="form-select" disabled id="reqMethod" name="reqMethod" required>
                                    <option value="">请选择请求方法</option>
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                    <option value="PUT">PUT</option>
                                    <option value="DELETE">DELETE</option>
                                    <option value="PATCH">PATCH</option>
                                </select>
                                <div class="form-text">对应数据库字段：req_method</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">请求头 <span class="text-danger">*</span></label>
                                <textarea class="form-control" disabled id="reqHeaders" name="reqHeaders"
                                          placeholder='{"Content-Type": "application/json", "Authorization": "Bearer token"}'
                                          required rows="3"></textarea>
                                <div class="form-text">对应数据库字段：req_headers</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">输入参数 <span class="text-danger">*</span></label>
                                <textarea class="form-control" disabled id="inputSchema" name="inputSchema"
                                          placeholder='{"param1": "value1", "param2": "value2"}'
                                          required rows="3"></textarea>
                                <div class="form-text">对应数据库字段：input_schema</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">输出参数 <span class="text-danger">*</span></label>
                                <textarea class="form-control" disabled id="outputSchema" name="outputSchema"
                                          placeholder='{"result": "success", "data": {...}}'
                                          required rows="3"></textarea>
                                <div class="form-text">对应数据库字段：output_schema</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">服务方app <span class="text-danger">*</span></label>
                                <input class="form-control" disabled id="providerAppNum" name="providerAppNum"
                                       placeholder="请输入服务方app名称"
                                       required type="text">
                                <div class="form-text">对应数据库字段：provider_app_num</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Expo工具表单 -->
                <div id="expo-tool-form" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">工具名称 <span class="text-danger">*</span></label>
                                <input class="form-control" disabled id="expoToolName" name="expoToolName"
                                       placeholder="请输入Expo工具名称"
                                       required type="text">
                                <div class="form-text">工具的标识名称，用于系统识别</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">工具版本 <span class="text-danger">*</span></label>
                                <input class="form-control" disabled id="expoToolVersion" name="expoToolVersion"
                                       placeholder="1.0.0" required type="text">
                                <div class="form-text">工具的版本号</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">应用类别</label>
                                <select class="form-select" disabled id="expoAppClass" name="expoAppClass">
                                    <option value="">请选择应用类别</option>
                                    <option value="1">Web应用</option>
                                    <option value="2">移动应用</option>
                                    <option value="3">桌面应用</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">命令ID</label>
                                <input class="form-control" disabled id="expoCommandId" name="expoCommandId"
                                       placeholder="100" type="number">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label required">工具描述 <span class="text-danger">*</span></label>
                        <textarea class="form-control" disabled id="expoDescription" name="expoDescription"
                                  placeholder="请描述这个Expo工具的功能和用途"
                                  required rows="4"></textarea>
                        <div class="form-text">详细说明工具的功能和使用场景</div>
                    </div>
                </div>

                <!-- 第二部分完成提示 -->
                <div class="alert alert-success" id="section2-completed" style="display: none;">
                    <i class="fas fa-check-circle me-2"></i>源工具信息录入完成！现在可以继续填写MCP工具信息。
                </div>
            </div>
        </div>

        <!-- ===== 第三部分：MCP工具信息 ===== -->
        <div class="card mb-4 section-locked" id="section3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>第三步：填写MCP工具信息
                    <span class="badge bg-warning ms-2" id="section3-lock">
                        <i class="fas fa-lock"></i> 请先完成源工具录入
                    </span>
                </h5>
                <small>基于源工具创建MCP工具信息</small>
            </div>
            <div class="card-body section-content-locked" style="opacity: 0.5; pointer-events: none;">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required">MCP工具英文名 <span class="text-danger">*</span></label>
                            <input class="form-control" disabled id="toolName" name="toolName"
                                   placeholder="请输入MCP工具英文名" required type="text">
                            <div class="form-text">对应数据库字段：tool_name</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required">MCP工具描述 <span class="text-danger">*</span></label>
                            <input class="form-control" disabled id="toolDescription" name="toolDescription"
                                   placeholder="请输入MCP工具描述" required type="text">
                            <div class="form-text">对应数据库字段：tool_description</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required">多语言名称 <span class="text-danger">*</span></label>
                            <input class="form-control" disabled id="mcpNameDisplay" name="mcpNameDisplay"
                                   placeholder="请输入多语言名称" required type="text">
                            <div class="form-text">对应数据库字段：name_display</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required">多语言描述 <span class="text-danger">*</span></label>
                            <input class="form-control" disabled id="descriptionDisplay" name="descriptionDisplay"
                                   placeholder="请输入多语言描述" required type="text">
                            <div class="form-text">对应数据库字段：description_display</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required">input_json_schema <span
                                    class="text-danger">*</span></label>
                            <textarea class="form-control" disabled id="mcpInputSchema" name="mcpInputSchema"
                                      placeholder='请输入JSON Schema格式的输入参数定义'
                                      required rows="3"></textarea>
                            <div class="form-text">对应数据库字段：input_schema</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required">output_json_schema <span
                                    class="text-danger">*</span></label>
                            <textarea class="form-control" disabled id="mcpOutputSchema" name="mcpOutputSchema"
                                      placeholder='请输入JSON Schema格式的输出参数定义'
                                      required rows="3"></textarea>
                            <div class="form-text">对应数据库字段：output_schema</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required">是否流式输出 <span class="text-danger">*</span></label>
                            <select class="form-select" disabled id="streamOutput" name="streamOutput" required>
                                <option value="">请选择是否流式输出</option>
                                <option value="0">否</option>
                                <option value="1">是</option>
                            </select>
                            <div class="form-text">对应数据库字段：stream_output</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required">转换模板类型 <span class="text-danger">*</span></label>
                            <input class="form-control" disabled id="convertType" name="convertType"
                                   placeholder="请输入转换模板类型" required type="text">
                            <div class="form-text">对应数据库字段：convert_type</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required">MCP工具类型 <span class="text-danger">*</span></label>
                            <select class="form-select" disabled id="toolType" name="toolType" required>
                                <option value="">请选择MCP工具类型</option>
                                <option value="HTTP工具">HTTP工具</option>
                                <option value="数据库工具">数据库工具</option>
                                <option value="文件工具">文件工具</option>
                                <option value="系统工具">系统工具</option>
                                <option value="网络工具">网络工具</option>
                                <option value="安全工具">安全工具</option>
                                <option value="开发工具">开发工具</option>
                                <option value="监控工具">监控工具</option>
                                <option value="其他">其他</option>
                            </select>
                            <div class="form-text">对应数据库字段：tool_type</div>
                        </div>
                    </div>
                </div>

                <!-- 第二部分完成提示 -->
                <div class="alert alert-success" id="section2-completed" style="display: none;">
                    <i class="fas fa-check-circle me-2"></i>MCP工具信息录入完成！现在可以继续设置转换模板。
                </div>
            </div>
        </div>

        <!-- ===== 第四部分：转换模板设置 ===== -->
        <div class="card mb-4 section-locked" id="section4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-exchange-alt me-2"></i>第四步：配置模板转换器
                    <span class="badge bg-secondary ms-2" id="section4-lock">
                        <i class="fas fa-lock"></i> 请先完成MCP工具信息录入
                    </span>
                </h5>
                <small>设置源工具到MCP工具的转换规则</small>
            </div>
            <div class="card-body section-content-locked" style="opacity: 0.5; pointer-events: none;">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required">请求路径 <span class="text-danger">*</span></label>
                            <input class="form-control" disabled id="templateReqUrl" name="templateReqUrl"
                                   placeholder="请输入请求路径" required type="text">
                            <div class="form-text">对应数据库字段：req_url</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required">请求方式 <span class="text-danger">*</span></label>
                            <select class="form-select" disabled id="templateReqMethod" name="templateReqMethod"
                                    required>
                                <option value="">请选择请求方式</option>
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                                <option value="PATCH">PATCH</option>
                            </select>
                            <div class="form-text">对应数据库字段：req_method</div>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label required">请求头（jinja2） <span class="text-danger">*</span></label>
                    <textarea class="form-control" disabled id="templateReqHeaders" name="templateReqHeaders"
                              placeholder='请输入jinja2格式的请求头模板' required rows="3"></textarea>
                    <div class="form-text">对应数据库字段：req_headers</div>
                </div>

                <div class="mb-3">
                    <label class="form-label required">请求体（jinja2） <span class="text-danger">*</span></label>
                    <textarea class="form-control" disabled id="reqBody" name="reqBody"
                              placeholder='请输入jinja2格式的请求体模板' required rows="5"></textarea>
                    <div class="form-text">对应数据库字段：req_body</div>
                </div>

                <div class="mb-3">
                    <label class="form-label required">响应体（jinja2） <span class="text-danger">*</span></label>
                    <textarea class="form-control" disabled id="respBody" name="respBody"
                              placeholder='请输入jinja2格式的响应体模板' required rows="5"></textarea>
                    <div class="form-text">对应数据库字段：resp_body</div>
                </div>

                <!-- 第四部分完成提示 -->
                <div class="alert alert-success" id="section4-completed" style="display: none;">
                    <i class="fas fa-check-circle me-2"></i>转换模板设置完成！所有信息已录入完整，可以保存了。
                </div>
            </div>
        </div>

        <!-- 保存按钮 -->
        <div class="card">
            <div class="card-body text-center">
                <button class="btn btn-success btn-lg" disabled id="saveBtn" type="submit">
                    <i class="fas fa-save me-2"></i>一键保存工具信息
                </button>
                <div class="form-text mt-2">
                    <i class="fas fa-info-circle me-1"></i>
                    请完成所有必填项后才能保存
                </div>
            </div>
        </div>
    </form>
</main>

<!-- 页脚 -->
<footer class="bg-light mt-5 py-4">
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <h5>MCP工具注册中心</h5>
                <p class="text-muted">统一管理和注册MCP工具的平台</p>
            </div>
            <div class="col-md-6 text-md-end">
                <p class="text-muted">
                    &copy; 2024 MCP工具注册中心. All rights reserved.
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- Bootstrap JS -->
<script src="/vendor/bootstrap/bootstrap-5.1.3.bundle.min.js"></script>
<!-- 自定义JS -->
<script th:src="@{/js/app.js}"></script>

<!-- 页面专用样式 -->
<style>
    .step-indicator {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 2rem;
    }

    .step {
        display: flex;
        align-items: center;
        margin: 0 1rem;
    }

    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 0.5rem;
    }

    .step.active .step-number {
        background: #0d6efd;
        color: white;
    }

    .step.completed .step-number {
        background: #198754;
        color: white;
    }

    .step.pending .step-number {
        background: #6c757d;
        color: white;
    }

    .section-locked .card-header {
        opacity: 0.7;
    }

    .required {
        font-weight: 600;
    }

    .form-control:focus {
        border-color: #198754;
        box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
    }

    .section-content-locked {
        transition: all 0.3s ease;
    }

    .alert {
        border: none;
        border-radius: 10px;
    }

    #saveBtn {
        min-width: 250px;
        padding: 12px 30px;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    #saveBtn:enabled {
        /* 移除跳动动画，避免影响点击 */
    }

    /* 删除pulse动画，提升用户体验 */
</style>

<!-- 页面专用JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 数据校验规则配置
        const validationRules = {
            // URL格式校验
            url: /^https?:\/\/([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/,
            // JSON格式校验
            json: function (value) {
                try {
                    JSON.parse(value);
                    return true;
                } catch (e) {
                    return false;
                }
            },
            // 工具名称校验（只允许字母、数字、连字符和下划线）
            toolName: /^[a-zA-Z0-9_-]{3,50}$/,
            // 版本号校验
            version: /^\d+\.\d+\.\d+(-[a-zA-Z0-9]+)?$/,
            // 非空校验
            required: function (value) {
                return value && value.trim().length > 0;
            },
            // 长度校验
            minLength: function (value, min) {
                return value && value.trim().length >= min;
            },
            maxLength: function (value, max) {
                return value && value.trim().length <= max;
            }
        };

        // 字段校验配置
        const fieldValidations = {
            // HTTP工具字段
            nameDisplay: [
                {rule: 'required', message: '名称不能为空'},
                {rule: 'minLength', param: 2, message: '名称至少需要2个字符'},
                {rule: 'maxLength', param: 100, message: '名称不能超过100个字符'}
            ],
            descDisplay: [
                {rule: 'required', message: '功能描述不能为空'},
                {rule: 'minLength', param: 10, message: '功能描述至少需要10个字符'},
                {rule: 'maxLength', param: 500, message: '功能描述不能超过500个字符'}
            ],
            reqUrl: [
                {rule: 'required', message: '请求URL不能为空'},
                {rule: 'url', message: '请输入有效的URL格式（如：https://api.example.com/endpoint）'}
            ],
            reqMethod: [
                {rule: 'required', message: '请选择请求方式'}
            ],
            reqHeaders: [
                {rule: 'required', message: '请求头不能为空'},
                {rule: 'json', message: '请求头必须是有效的JSON格式'}
            ],
            inputSchema: [
                {rule: 'required', message: '输入参数不能为空'},
                {rule: 'json', message: '输入参数必须是有效的JSON格式'}
            ],
            outputSchema: [
                {rule: 'required', message: '输出参数不能为空'},
                {rule: 'json', message: '输出参数必须是有效的JSON格式'}
            ],
            providerAppNum: [
                {rule: 'required', message: '服务方app不能为空'},
                {rule: 'minLength', param: 1, message: '服务方app编号不能为空'}
            ],
            // Expo工具字段
            expoToolName: [
                {rule: 'required', message: '工具名称不能为空'},
                {rule: 'toolName', message: '工具名称只能包含字母、数字、连字符和下划线，长度3-50个字符'}
            ],
            expoToolVersion: [
                {rule: 'required', message: '工具版本不能为空'},
                {rule: 'version', message: '版本号格式不正确，请使用语义化版本（如：1.0.0）'}
            ],
            expoDescription: [
                {rule: 'required', message: '工具描述不能为空'},
                {rule: 'minLength', param: 10, message: '工具描述至少需要10个字符'},
                {rule: 'maxLength', param: 500, message: '工具描述不能超过500个字符'}
            ],
            // MCP工具字段
            toolName: [
                {rule: 'required', message: 'MCP工具英文名不能为空'},
                {rule: 'toolName', message: 'MCP工具英文名只能包含字母、数字、连字符和下划线，长度3-50个字符'}
            ],
            toolDescription: [
                {rule: 'required', message: 'MCP工具描述不能为空'},
                {rule: 'minLength', param: 10, message: 'MCP工具描述至少需要10个字符'},
                {rule: 'maxLength', param: 200, message: 'MCP工具描述不能超过200个字符'}
            ],
            mcpNameDisplay: [
                {rule: 'required', message: '多语言名称不能为空'},
                {rule: 'minLength', param: 2, message: '多语言名称至少需要2个字符'}
            ],
            descriptionDisplay: [
                {rule: 'required', message: '多语言描述不能为空'},
                {rule: 'minLength', param: 10, message: '多语言描述至少需要10个字符'}
            ],
            mcpInputSchema: [
                {rule: 'required', message: 'input_json_schema不能为空'},
                {rule: 'json', message: 'input_json_schema必须是有效的JSON Schema格式'}
            ],
            mcpOutputSchema: [
                {rule: 'required', message: 'output_json_schema不能为空'},
                {rule: 'json', message: 'output_json_schema必须是有效的JSON Schema格式'}
            ],
            streamOutput: [
                {rule: 'required', message: '请选择是否流式输出'}
            ],
            convertType: [
                {rule: 'required', message: '转换模板类型不能为空'},
                {rule: 'minLength', param: 2, message: '转换模板类型至少需要2个字符'}
            ],
            toolType: [
                {rule: 'required', message: '请选择MCP工具类型'}
            ],
            // 模板转换器字段
            templateReqUrl: [
                {rule: 'required', message: '请求路径不能为空'},
                {rule: 'minLength', param: 1, message: '请求路径不能为空'}
            ],
            templateReqMethod: [
                {rule: 'required', message: '请选择请求方式'}
            ],
            templateReqHeaders: [
                {rule: 'required', message: '请求头模板不能为空'},
                {rule: 'minLength', param: 5, message: '请求头模板内容过短'}
            ],
            reqBody: [
                {rule: 'required', message: '请求体模板不能为空'},
                {rule: 'minLength', param: 5, message: '请求体模板内容过短'}
            ],
            respBody: [
                {rule: 'required', message: '响应体模板不能为空'},
                {rule: 'minLength', param: 5, message: '响应体模板内容过短'}
            ]
        };

        // 校验单个字段
        function validateField(fieldId, value) {
            const validations = fieldValidations[fieldId];
            if (!validations) return {valid: true};

            for (let validation of validations) {
                const rule = validation.rule;
                let isValid = false;

                if (typeof validationRules[rule] === 'function') {
                    if (validation.param !== undefined) {
                        isValid = validationRules[rule](value, validation.param);
                    } else {
                        isValid = validationRules[rule](value);
                    }
                } else if (validationRules[rule] instanceof RegExp) {
                    isValid = validationRules[rule].test(value);
                }

                if (!isValid) {
                    return {valid: false, message: validation.message};
                }
            }

            return {valid: true};
        }

        // 显示字段错误信息
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            if (!field) return;

            // 移除之前的错误状态
            field.classList.remove('is-valid', 'is-invalid');

            // 移除之前的错误信息
            const existingError = field.parentNode.querySelector('.invalid-feedback');
            if (existingError) {
                existingError.remove();
            }

            if (message) {
                // 添加错误状态
                field.classList.add('is-invalid');

                // 添加错误信息
                const errorDiv = document.createElement('div');
                errorDiv.className = 'invalid-feedback';
                errorDiv.textContent = message;
                field.parentNode.appendChild(errorDiv);
            } else {
                // 添加成功状态
                field.classList.add('is-valid');
            }
        }

        // 实时校验字段
        function setupRealTimeValidation() {
            Object.keys(fieldValidations).forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    // 失去焦点时校验
                    field.addEventListener('blur', function () {
                        const result = validateField(fieldId, this.value);
                        showFieldError(fieldId, result.valid ? null : result.message);

                        // 检查当前部分是否完成
                        checkCurrentSectionCompletion();
                    });

                    // 输入时清除错误状态（延迟校验）
                    let timeout;
                    field.addEventListener('input', function () {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => {
                            const result = validateField(fieldId, this.value);
                            if (result.valid) {
                                showFieldError(fieldId, null);
                            }
                            checkCurrentSectionCompletion();
                        }, 500);
                    });
                }
            });
        }

        // 检查当前部分完成状态
        function checkCurrentSectionCompletion() {
            // 检查每个部分的完成状态
            for (let i = 1; i <= 4; i++) {
                if (checkSectionCompletion(`section${i}`)) {
                    if (i < 4) {
                        unlockNextSection(i);
                    }
                    checkSaveButton();
                }
            }
        }

        // 必填字段配置
        const requiredFields = {
            section1: [], // 第一步只需要选择工具类型，通过点击事件验证
            section2: [], // 动态设置，根据选择的工具类型
            section3: ['toolName', 'toolDescription', 'mcpNameDisplay', 'descriptionDisplay', 'mcpInputSchema', 'mcpOutputSchema', 'streamOutput', 'convertType', 'toolType'],
            section4: ['templateReqUrl', 'templateReqMethod', 'templateReqHeaders', 'reqBody', 'respBody']
        };

        let selectedToolType = '';

        // 工具类型卡片点击事件
        document.querySelectorAll('.tool-type-card').forEach(card => {
            card.addEventListener('click', function () {
                // 移除其他卡片的选中状态
                document.querySelectorAll('.tool-type-card').forEach(c => {
                    c.classList.remove('border-primary');
                    c.style.borderWidth = '1px';
                });

                // 添加选中状态
                this.classList.add('border-primary');
                this.style.borderWidth = '3px';

                // 设置选中的工具类型
                selectedToolType = this.dataset.type;
                document.getElementById('selectedToolType').value = selectedToolType;

                // 设置第二步的必填字段
                if (selectedToolType === 'http') {
                    requiredFields.section2 = ['nameDisplay', 'descDisplay', 'reqUrl', 'reqMethod', 'reqHeaders', 'inputSchema', 'outputSchema', 'providerAppNum'];
                } else if (selectedToolType === 'expo') {
                    requiredFields.section2 = ['expoToolName', 'expoToolVersion', 'expoDescription'];
                }

                // 检查是否可以进入下一步
                if (checkSectionCompletion('section1')) {
                    unlockNextSection(1);
                }
            });
        });

        // 检查每个部分的完成状态（增强版本）
        function checkSectionCompletion(sectionId) {
            if (sectionId === 'section1') {
                return selectedToolType !== '';
            }

            const fields = requiredFields[sectionId];
            return fields.every(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field) return false;

                // 检查字段值是否有效
                const result = validateField(fieldId, field.value);
                return result.valid && field.value.trim() !== '';
            });
        }

        // 解锁下一个部分
        function unlockNextSection(currentSection) {
            const nextSection = currentSection + 1;
            if (nextSection <= 4) {
                const nextSectionElement = document.getElementById(`section${nextSection}`);
                const nextLockElement = document.getElementById(`section${nextSection}-lock`);
                const nextContentElement = nextSectionElement.querySelector('.section-content-locked');

                // 移除锁定状态
                nextSectionElement.classList.remove('section-locked');
                nextLockElement.style.display = 'none';
                nextContentElement.style.opacity = '1';
                nextContentElement.style.pointerEvents = 'auto';

                // 根据选择的工具类型显示对应的表单
                if (nextSection === 2) {
                    if (selectedToolType === 'http') {
                        document.getElementById('http-tool-form').style.display = 'block';
                        document.getElementById('expo-tool-form').style.display = 'none';
                    } else if (selectedToolType === 'expo') {
                        document.getElementById('http-tool-form').style.display = 'none';
                        document.getElementById('expo-tool-form').style.display = 'block';
                    }
                }

                // 启用字段
                const fields = requiredFields[`section${nextSection}`];
                fields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) field.disabled = false;
                });

                // 启用其他字段
                const allInputs = nextSectionElement.querySelectorAll('input, textarea, select');
                allInputs.forEach(input => input.disabled = false);

                // 更新进度指示器
                const nextIndicator = document.getElementById(`step-${nextSection}`);
                if (nextIndicator) {
                    nextIndicator.classList.remove('pending');
                    nextIndicator.classList.add('active');
                }

                // 显示完成提示
                const completedAlert = document.getElementById(`section${currentSection}-completed`);
                if (completedAlert) {
                    completedAlert.style.display = 'block';
                }

                // 移除自动滚动，避免页面抖动
                // nextSectionElement.scrollIntoView({behavior: 'smooth', block: 'start'});
            }
        }

        // 检查是否可以启用保存按钮（增强版本）
        function checkSaveButton() {
            const allCompleted = Object.keys(requiredFields).every(section => checkSectionCompletion(section));
            const saveBtn = document.getElementById('saveBtn');

            if (allCompleted) {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>一键保存工具信息';
                saveBtn.classList.remove('btn-secondary');
                saveBtn.classList.add('btn-success');

                // 显示最终完成提示
                const section4Completed = document.getElementById('section4-completed');
                if (section4Completed) {
                    section4Completed.style.display = 'block';
                }

                // 更新所有进度指示器为完成状态
                for (let i = 1; i <= 4; i++) {
                    const indicator = document.getElementById(`step-${i}`);
                    if (indicator) {
                        indicator.classList.add('completed');
                        indicator.classList.remove('active');
                        indicator.classList.remove('pending');
                    }
                }
            } else {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-lock me-2"></i>请完成所有必填项';
                saveBtn.classList.remove('btn-success');
                saveBtn.classList.add('btn-secondary');
            }
        }

        // 表单提交前的最终校验
        function validateAllFields() {
            let isValid = true;
            const errors = [];

            // 校验所有相关字段
            const fieldsToValidate = [];

            // 根据选择的工具类型添加字段
            if (selectedToolType === 'http') {
                fieldsToValidate.push(...requiredFields.section2);
            } else if (selectedToolType === 'expo') {
                fieldsToValidate.push(...requiredFields.section2);
            }

            fieldsToValidate.push(...requiredFields.section3);
            fieldsToValidate.push(...requiredFields.section4);

            fieldsToValidate.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    const result = validateField(fieldId, field.value);
                    if (!result.valid) {
                        isValid = false;
                        errors.push(`${fieldId}: ${result.message}`);
                        showFieldError(fieldId, result.message);
                    }
                }
            });

            return {valid: isValid, errors};
        }

        // 保存按钮直接点击事件处理 - 确保100%请求后端
        document.getElementById('saveBtn').addEventListener('click', function (e) {
            e.preventDefault();

            // 获取表单引用
            const form = document.getElementById('unifiedForm');

            // 显示保存中状态（立即显示，确保用户看到响应）
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>正在保存...';

            // 最终校验
            const validation = validateAllFields();
            if (!validation.valid) {
                // 校验失败，恢复按钮状态
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>一键保存工具信息';

                // 显示错误信息
                const errorsList = validation.errors.map(error => `<li>${error}</li>`).join('');
                showMessage('danger', '表单验证失败！', `请检查并修正以下错误：<ul class="mb-0 mt-2">${errorsList}</ul>`);
                return;
            }

            // 构建表单数据
            const formData = new FormData(form);

            // 使用fetch API直接调用后端接口
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status} - ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(result => {
                    if (result === 'success') {
                        saveBtn.innerHTML = '<i class="fas fa-check me-2"></i>保存成功！';
                        saveBtn.classList.remove('btn-success');
                        saveBtn.classList.add('btn-outline-success');

                        // 显示成功消息
                        showMessage('success', '保存成功！', '工具信息已成功录入系统。<div class="mt-2"><small>3秒后将自动跳转到工具列表页面...</small></div>');

                        // 3秒后跳转
                        setTimeout(() => {
                            window.location.href = '/mcp-tools';
                        }, 3000);
                    } else {
                        handleSaveError('保存失败：' + result);
                    }
                })
                .catch(error => {
                    handleSaveError(error.message || '网络连接错误，请检查网络后重试');
                });

            // 错误处理函数
            function handleSaveError(errorMessage) {
                console.error('保存错误:', errorMessage);
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>保存失败，请重试';
                saveBtn.classList.remove('btn-success');
                saveBtn.classList.add('btn-danger');

                showMessage('danger', '保存失败！', errorMessage);
            }
        });

        // 表单提交事件处理（作为备用，防止直接提交）
        document.getElementById('unifiedForm').addEventListener('submit', function (e) {
            e.preventDefault(); // 阻止默认提交，统一通过按钮点击处理
            document.getElementById('saveBtn').click(); // 触发按钮点击事件
        });

        // 统一的消息显示函数
        function showMessage(type, title, content, autoHide = false, hideDelay = 3000) {
            const messageContainer = document.getElementById('messageContainer');
            const iconMap = {
                success: 'fas fa-check-circle',
                danger: 'fas fa-exclamation-triangle',
                warning: 'fas fa-exclamation-circle',
                info: 'fas fa-info-circle'
            };

            const icon = iconMap[type] || iconMap.info;
            let alertHTML = `
                <div class="alert alert-${type} alert-dismissible fade show">
                    <i class="${icon} me-2"></i>
                    <strong>${title}</strong> ${content}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            messageContainer.innerHTML = alertHTML;
            messageContainer.style.display = 'block';

            // 自动隐藏
            if (autoHide) {
                setTimeout(() => {
                    messageContainer.style.display = 'none';
                }, hideDelay);
            }

            // 不滚动到顶部，避免页面抖动
            return messageContainer.firstElementChild;
        }

        // 隐藏消息
        function hideMessage() {
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.style.display = 'none';
            messageContainer.innerHTML = '';
        }

        // 初始化实时校验
        setupRealTimeValidation();
    });
</script>
</body>
</html>