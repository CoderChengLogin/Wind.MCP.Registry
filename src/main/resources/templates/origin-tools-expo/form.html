<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title th:text="${tool.id != null ? '编辑工具 - ' + tool.nameDisplay : '添加新工具'} + ' - MCP工具注册中心'">添加新工具
        -
        MCP工具注册中心</title>
    <link href="/vendor/bootstrap/bootstrap-5.3.0.min.css" rel="stylesheet">
    <link href="/vendor/fontawesome/all-6.4.0.min.css" rel="stylesheet">
    <style>
        .navbar-brand {
            font-weight: bold;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .required {
            color: #dc3545;
        }

        .xml-editor {
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
<!-- 导航栏 -->
<nav th:replace="~{fragments/navigation :: navbar}"></nav>

<div class="container mt-4">
    <!-- 面包屑导航 -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">首页</a></li>
            <li class="breadcrumb-item"><a href="/origin-expo-tools">原始Expo接口</a></li>
            <li class="breadcrumb-item active" th:text="${tool.id != null ? '编辑工具' : '添加新工具'}">添加新工具</li>
        </ol>
    </nav>

    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="fas fa-puzzle-piece me-2"></i>
            <span th:text="${tool.id != null ? '编辑工具' : '添加新工具'}">添加新工具</span>
        </h1>
        <a class="btn btn-outline-secondary" href="/origin-expo-tools">
            <i class="fas fa-arrow-left me-2"></i>返回列表
        </a>
    </div>

    <!-- 工具表单 -->
    <form id="toolForm" method="post" th:action="@{/origin-expo-tools/save}">
        <input th:field="${tool.id}" type="hidden">
        <!-- 隐藏字段:保存当前应用名称用于编辑时回显 -->
        <input id="currentAppName" th:value="${providerApp != null ? providerApp.appName : ''}" type="hidden">

        <!-- 基本信息 -->
        <div class="form-section">
            <h4 class="mb-3"><i class="fas fa-info-circle me-2"></i>基本信息</h4>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="name">名称 <span class="required">*</span></label>
                        <input class="form-control" id="name" placeholder="请输入工具名称" required
                               th:field="${tool.nameDisplay}"
                               type="text">
                        <div class="form-text">对应数据库字段：name_display</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="description">功能描述 <span class="required">*</span></label>
                        <textarea class="form-control" id="description" placeholder="请描述这个工具的功能" required
                                  rows="3" th:field="${tool.descDisplay}"></textarea>
                        <div class="form-text">对应数据库字段：desc_display</div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label" for="functionName">函数名称 <span class="required">*</span></label>
                        <input class="form-control" id="functionName" placeholder="函数名称" required
                               th:field="${tool.functionName}"
                               type="text">
                        <div class="form-text">对应数据库字段：function_name</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label" for="appClass">appClass <span class="required">*</span></label>
                        <input class="form-control" id="appClass" placeholder="appClass" required
                               th:field="${tool.appClass}"
                               type="number">
                        <div class="form-text">对应数据库字段：app_class</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label" for="commandId">commandId <span class="required">*</span></label>
                        <input class="form-control" id="commandId" placeholder="commandId" required
                               th:field="${tool.commandId}"
                               type="number">
                        <div class="form-text">对应数据库字段：command_id</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Expo配置 -->
        <div class="form-section">
            <h4 class="mb-3"><i class="fas fa-cog me-2"></i>Expo配置</h4>

            <div class="row">
                <div class="col-md-12">
                    <div class="mb-3">
                        <label class="form-label" for="expoApiDefine">API定义(XML) <span
                                class="required">*</span></label>
                        <textarea class="form-control xml-editor" id="expoApiDefine"
                                  placeholder='<?xml version="1.0"?><api>...</api>'
                                  required rows="10"
                                  th:field="${tool.expoApiDefine}"></textarea>
                        <div class="form-text">对应数据库字段：expo_api_define，使用XML格式定义API</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 提供者配置 -->
        <div class="form-section">
            <h4 class="mb-3"><i class="fas fa-sliders-h me-2"></i>提供者配置</h4>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="providerToolNum">提供者工具编号</label>
                        <input class="form-control" id="providerToolNum"
                               placeholder="提供者工具编号"
                               th:field="${tool.providerToolNum}"
                               type="number">
                        <div class="form-text">对应数据库字段：provider_tool_num</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="providerToolName">提供者工具名称</label>
                        <input class="form-control" id="providerToolName"
                               placeholder="提供者工具名称"
                               th:field="${tool.providerToolName}"
                               type="text">
                        <div class="form-text">对应数据库字段：provider_tool_name</div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="providerAppNum">服务方app</label>
                        <select class="form-select" id="providerAppNum" th:field="${tool.providerAppNum}">
                            <option value="">请选择服务方app</option>
                            <!-- 动态加载已注册的应用节点 -->
                        </select>
                        <div class="form-text">只能选择已注册的应用服务节点,对应数据库字段：provider_app_num</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 提交按钮 -->
        <div class="d-flex justify-content-end gap-2">
            <a class="btn btn-secondary" href="/origin-expo-tools">
                <i class="fas fa-times me-2"></i>取消
            </a>
            <button class="btn btn-success" type="submit">
                <i class="fas fa-save me-2"></i>保存工具
            </button>
        </div>
    </form>
</div>

<script src="/vendor/bootstrap/bootstrap-5.3.0.bundle.min.js"></script>
<script>
    // 表单验证
    document.getElementById('toolForm').addEventListener('submit', function (e) {
        // 验证XML格式
        const xmlField = document.getElementById('expoApiDefine');
        if (xmlField && xmlField.value.trim()) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlField.value, "text/xml");
                const errorNode = xmlDoc.querySelector('parsererror');
                if (errorNode) {
                    e.preventDefault();
                    alert('API定义的XML格式不正确，请检查后重试');
                    xmlField.focus();
                    return;
                }
            } catch (error) {
                e.preventDefault();
                alert('API定义的XML格式不正确: ' + error.message);
                xmlField.focus();
                return;
            }
        }
    });

    // XML格式化
    function formatXml(xml) {
        const PADDING = ' '.repeat(2);
        const reg = /(>)(<)(\/*)/g;
        let pad = 0;

        xml = xml.replace(reg, '$1\r\n$2$3');

        return xml.split('\r\n').map((node, index) => {
            let indent = 0;
            if (node.match(/.+<\/\w[^>]*>$/)) {
                indent = 0;
            } else if (node.match(/^<\/\w/) && pad > 0) {
                pad -= 1;
            } else if (node.match(/^<\w[^>]*[^\/]>.*$/)) {
                indent = 1;
            } else {
                indent = 0;
            }

            pad += indent;

            return PADDING.repeat(pad - indent) + node;
        }).join('\r\n');
    }

    /**
     * 加载已注册的应用节点列表
     * 用于填充服务方app下拉选择框
     */
    function loadProviderApps() {
        fetch('/provider-app/listEnabled')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.apps) {
                    const select = document.getElementById('providerAppNum');
                    // 获取当前应用名称(编辑模式时使用)
                    const currentAppName = document.getElementById('currentAppName')?.value;

                    // 清空现有选项(保留第一个"请选择"选项)
                    select.innerHTML = '<option value="">请选择服务方app</option>';

                    // 添加应用节点选项(只显示应用名称,系统会自动负载均衡选择最佳节点)
                    data.apps.forEach(app => {
                        const option = document.createElement('option');
                        option.value = app.id;
                        // 只显示应用名称,不显示具体站点信息
                        option.textContent = app.appName;
                        // 如果需要显示更多信息,可以添加到title属性
                        option.title = `${app.appName} - ${app.siteType || '默认站点'} (${app.appIp}:${app.appPort})`;
                        // 保存应用名称到option的data属性,用于匹配
                        option.dataset.appName = app.appName;
                        select.appendChild(option);
                    });

                    // 如果是编辑模式,根据应用名称匹配选中项
                    if (currentAppName) {
                        // 遍历所有option,找到匹配的应用名称
                        for (let i = 0; i < select.options.length; i++) {
                            const option = select.options[i];
                            if (option.dataset.appName === currentAppName) {
                                select.selectedIndex = i;
                                break;
                            }
                        }
                    }
                } else {
                    console.error('加载应用节点失败:', data.message);
                }
            })
            .catch(error => {
                console.error('加载应用节点时出错:', error);
            });
    }

    // 为XML编辑器添加格式化功能
    document.addEventListener('DOMContentLoaded', function () {
        // 加载应用节点列表
        loadProviderApps();

        const xmlEditor = document.getElementById('expoApiDefine');
        if (xmlEditor) {
            xmlEditor.addEventListener('blur', function () {
                if (this.value.trim()) {
                    try {
                        this.value = formatXml(this.value);
                    } catch (error) {
                        // 静默处理，不打断用户输入
                    }
                }
            });
        }
    });
</script>
</body>
</html>