<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>MCP工具列表 - MCP工具注册中心</title>

    <!-- Bootstrap CSS -->
    <link href="/vendor/bootstrap/bootstrap-5.1.3.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="/vendor/fontawesome/all-6.0.0.min.css" rel="stylesheet">
    <!-- 自定义CSS -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <!-- Toast通知组件CSS -->
    <link rel="stylesheet" th:href="@{/css/toast.css}">

    <style>
        .navbar-brand {
            font-weight: bold;
        }

        .search-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        /* 单行布局样式 */
        .tool-list-table {
            width: 100%;
            border-collapse: collapse;
        }

        .tool-list-table thead {
            background-color: #f8f9fa;
        }

        .tool-list-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }

        .tool-list-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
        }

        .tool-list-table tbody tr {
            border-left: 4px solid #28a745;
        }

        .tool-list-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        /* 文本截断和hover显示全文 */
        .text-truncate-hover {
            max-width: 250px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            cursor: pointer;
        }

        .text-truncate-hover:hover {
            overflow: visible;
            white-space: normal;
            background-color: #333;
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            position: absolute;
            max-width: 400px;
            word-wrap: break-word;
        }

        .tool-name-col {
            max-width: 180px;
        }

        .tool-desc-col {
            max-width: 280px;
        }

        .tool-type-col {
            width: 100px;
        }

        .tool-convert-col {
            width: 110px;
        }

        .tool-time-col {
            width: 130px;
        }

        .tool-status-col {
            width: 80px;
        }

        .tool-actions-col {
            width: 150px;
        }

        /* 分页信息文本样式 */
        .pagination-info {
            color: #6c757d;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
<!-- 导航栏 -->
<nav th:replace="~{fragments/navigation :: navbar}"></nav>

<div class="container mt-4">
    <!-- 面包屑导航 -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">首页</a></li>
            <li class="breadcrumb-item active">MCP工具</li>
        </ol>
    </nav>

    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-cogs me-2"></i>MCP工具列表</h1>
        <div>
            <a class="btn btn-primary" th:href="@{/tool-wizard}">
                <i class="fas fa-plus me-2"></i>分步向导添加
            </a>
            <button class="btn btn-primary" id="importToolBtn" type="button">
                <i class="fas fa-file-import me-2"></i>导入工具
            </button>
        </div>
    </div>

    <!-- 搜索框 -->
    <div class="search-box">
        <div class="row align-items-center">
            <div class="col-md-9">
                <input class="form-control" id="searchInput" placeholder="搜索工具名称或描述..." type="text">
            </div>
            <div class="col-md-3">
                <button class="btn btn-outline-secondary w-100" onclick="filterTools()">
                    <i class="fas fa-search me-2"></i>搜索
                </button>
            </div>
        </div>
    </div>

    <!-- 工具列表 -->
    <div th:if="${not #lists.isEmpty(tools)}">
        <table class="table tool-list-table">
            <thead>
            <tr>
                <th class="tool-name-col">工具名称</th>
                <th class="tool-desc-col">描述</th>
                <th class="tool-type-col">工具类型</th>
                <th class="tool-convert-col">转换类型</th>
                <th class="tool-time-col">创建时间</th>
                <th class="tool-status-col">状态</th>
                <th class="tool-actions-col">操作</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="tool : ${tools}">
                <td>
                    <div class="text-truncate-hover"
                         th:attr="data-full-text=${tool.toolName}"
                         th:text="${tool.toolName}">工具名称
                    </div>
                </td>
                <td>
                    <div class="text-truncate-hover"
                         th:attr="data-full-text=${tool.toolDescription}"
                         th:text="${tool.toolDescription}">工具描述
                    </div>
                </td>
                <td>
                    <span class="badge bg-info" th:text="${tool.toolType == '1' ? 'Tool' : 'Agent'}">Tool</span>
                </td>
                <td>
                        <span class="badge bg-success"
                              th:if="${tool.convertType != null and (tool.convertType == '1' or tool.convertType.toLowerCase().contains('http'))}">
                            <i class="fas fa-globe me-1"></i>HTTP
                        </span>
                        <span class="badge bg-primary"
                              th:if="${tool.convertType != null and (tool.convertType == '2' or tool.convertType.equalsIgnoreCase('expo'))}">
                            <i class="fas fa-server me-1"></i>Expo
                        </span>
                        <span class="badge bg-warning"
                              th:if="${tool.convertType != null and (tool.convertType == '3' or tool.convertType.equalsIgnoreCase('manual') or tool.convertType.equalsIgnoreCase('code'))}">
                            <i class="fas fa-code me-1"></i>手动
                        </span>
                </td>
                <td>
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>
                        <span th:text="${#temporals.format(tool.createTime, 'yyyy-MM-dd HH:mm')}">2024-01-01 10:00</span>
                    </small>
                </td>
                <td>
                    <span class="badge bg-success" th:if="${tool.valid == '1'}">有效</span>
                    <span class="badge bg-secondary" th:if="${tool.valid != '1'}">无效</span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <a class="btn btn-outline-primary" th:href="@{/mcp-tools/{id}(id=${tool.id})}" title="查看">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a class="btn btn-outline-secondary"
                           th:if="${currentProviderId != null and (tool.providerId == currentProviderId)}"
                           th:href="@{/mcp-tools/edit/{id}(id=${tool.id})}"
                           title="编辑">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button class="btn btn-outline-secondary permission-denied-edit-btn"
                                th:if="${currentProviderId == null or (tool.providerId != currentProviderId)}"
                                th:data-tool-name="${tool.toolName}"
                                title="编辑" type="button">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger delete-btn"
                                th:if="${currentProviderId != null and (tool.providerId == currentProviderId)}"
                                th:data-tool-id="${tool.id}"
                                th:data-tool-name="${tool.toolName}"
                                title="删除" type="button">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-outline-danger permission-denied-delete-btn"
                                th:if="${currentProviderId == null or (tool.providerId != currentProviderId)}"
                                th:data-tool-name="${tool.toolName}"
                                title="删除" type="button">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- 空状态 -->
    <div class="text-center py-5" th:if="${#lists.isEmpty(tools)}">
        <i class="fas fa-cogs fa-4x text-muted mb-3"></i>
        <h3 class="text-muted">暂无MCP工具</h3>
        <p class="text-muted">当前没有找到任何MCP工具。</p>
        <a class="btn btn-primary" th:href="@{/tool-wizard}">
            <i class="fas fa-plus me-2"></i>立即创建
        </a>
    </div>

    <!-- 分页组件 -->
    <nav aria-label="Page navigation" class="mt-4" th:if="${not #lists.isEmpty(tools)}">
        <ul class="pagination justify-content-center">
            <li class="page-item" th:classappend="${currentPage == 1 or currentPage == null} ? 'disabled'">
                <a aria-label="Previous" class="page-link"
                   th:href="@{/mcp-tools(page=${currentPage != null ? currentPage - 1 : 0})}">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>

            <th:block th:if="${totalPages != null and totalPages > 0}">
                <li class="page-item"
                    th:classappend="${i == currentPage} ? 'active'"
                    th:each="i : ${#numbers.sequence(1, totalPages)}">
                    <a class="page-link" th:href="@{/mcp-tools(page=${i})}" th:text="${i}">1</a>
                </li>
            </th:block>

            <th:block th:if="${totalPages == null or totalPages == 0}">
                <li class="page-item active">
                    <a class="page-link">1</a>
                </li>
            </th:block>

            <li class="page-item"
                th:classappend="${currentPage == totalPages or totalPages == null or totalPages <= 1} ? 'disabled'">
                <a aria-label="Next" class="page-link"
                   th:href="@{/mcp-tools(page=${currentPage != null ? currentPage + 1 : 2})}">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
    </nav>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <p>您确定要删除工具 "<span id="deleteToolName"></span>" 吗？</p>
                <p class="text-danger">此操作不可撤销!</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">取消</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    <button class="btn btn-danger" type="submit">确认删除</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 无权限提示模态框 -->
<div class="modal fade" id="permissionDeniedModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">无权限操作</h5>
                <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-lock me-2"></i>
                    <span id="permissionMessage">您没有权限执行此操作。只有工具的创建者才能编辑或删除该工具。</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" data-bs-dismiss="modal" type="button">我知道了</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="/vendor/bootstrap/bootstrap-5.1.3.bundle.min.js"></script>
<!-- Toast通知组件JS -->
<script src="/js/toast.js"></script>
<!-- 导入工具管理器 -->
<script src="/js/import-util.js"></script>

<script>
    /**
     * 确认删除工具
     */
    function confirmDelete(toolId, toolName) {
        document.getElementById('deleteToolName').textContent = toolName;
        document.getElementById('deleteForm').action = '/mcp-tools/delete/' + toolId;
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }

    /**
     * 显示无权限提示
     */
    function showPermissionDenied(toolName, action) {
        const message = `您没有${action}工具 "${toolName}" 的权限。只有工具的创建者才能${action}该工具。`;
        document.getElementById('permissionMessage').textContent = message;
        new bootstrap.Modal(document.getElementById('permissionDeniedModal')).show();
    }

    /**
     * 前端搜索过滤
     */
    function filterTools() {
        const searchKeyword = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.querySelectorAll('tbody tr');
        let visibleCount = 0;

        rows.forEach(row => {
            const toolName = row.querySelector('td:nth-child(1)')?.textContent.toLowerCase() || '';
            const toolDescription = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';

            const matches = !searchKeyword ||
                toolName.includes(searchKeyword) ||
                toolDescription.includes(searchKeyword);

            row.style.display = matches ? '' : 'none';
            if (matches) visibleCount++;
        });
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function () {
        // Toast通知
        const urlParams = new URLSearchParams(window.location.search);
        const successMsg = urlParams.get('success');
        const errorMsg = urlParams.get('error');

        if (successMsg) {
            showSuccess(decodeURIComponent(successMsg));
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        if (errorMsg) {
            showError(decodeURIComponent(errorMsg));
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // 搜索功能
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', filterTools);
            searchInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    filterTools();
                }
            });
        }

        // 删除按钮
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function () {
                const toolId = this.dataset.toolId;
                const toolName = this.dataset.toolName;
                confirmDelete(toolId, toolName);
            });
        });

        // 无权限编辑按钮
        document.querySelectorAll('.permission-denied-edit-btn').forEach(button => {
            button.addEventListener('click', function () {
                const toolName = this.dataset.toolName;
                showPermissionDenied(toolName, '编辑');
            });
        });

        // 无权限删除按钮
        document.querySelectorAll('.permission-denied-delete-btn').forEach(button => {
            button.addEventListener('click', function () {
                const toolName = this.dataset.toolName;
                showPermissionDenied(toolName, '删除');
            });
        });

        // 导入工具按钮
        const importToolBtn = document.getElementById('importToolBtn');
        if (importToolBtn) {
            importToolBtn.addEventListener('click', function () {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';

                fileInput.onchange = async function (e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        await ImportToolManager.handleImport(file);
                    } catch (error) {
                        ImportToolManager.showNotification(error.message, 'error');
                    }
                };

                fileInput.click();
            });
        }
    });
</script>
</body>
</html>
