<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title th:text="${tool.toolName} + ' - MCP工具注册中心'">工具详情 - MCP工具注册中心</title>

    <!-- Bootstrap CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="/css/all.min.css" rel="stylesheet">
    <!-- Prism.js for code highlighting -->
    <link href="/vendor/prism/prism-1.24.1.min.css" rel="stylesheet">
    <!-- 自定义CSS -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<!-- 导航栏 -->
<nav th:replace="~{fragments/navigation :: navbar}"></nav>

<!-- 主要内容区域 -->
<main class="container mt-4">
    <!-- 面包屑导航 -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/}">首页</a></li>
            <li class="breadcrumb-item"><a th:href="@{/mcp-tools}">MCP工具</a></li>
            <li class="breadcrumb-item active" th:text="${tool.toolName}">工具详情</li>
        </ol>
    </nav>

    <!-- 工具标题和操作 -->
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h1 class="mb-2">
                <i class="fas fa-cogs me-2"></i>
                <span th:text="${tool.toolName}">工具名称</span>
            </h1>
            <div class="mb-2">
                    <span class="badge me-2"
                          th:classappend="${tool.valid == '1' ? 'bg-success' : 'bg-secondary'}"
                          th:text="${tool.valid == '1' ? '有效' : '无效'}">状态</span>
                <span class="badge bg-info me-2" th:if="${tool.toolType}"
                      th:text="${tool.toolType == '1' ? 'tool' : (tool.toolType == '2' ? 'agent' : tool.toolType)}">类型</span>
                <span class="badge bg-secondary" th:if="${tool.toolVersion}"
                      th:text="'v' + ${tool.toolVersion}">版本</span>
            </div>
        </div>

        <div class="btn-group" role="group">
            <a class="btn btn-outline-primary" th:href="@{/mcp-tools/edit/{id}(id=${tool.id})}">
                <i class="fas fa-edit me-1"></i>编辑
            </a>
            <a class="btn btn-outline-secondary" th:href="@{/mcp-tools}">
                <i class="fas fa-arrow-left me-1"></i>返回列表
            </a>
        </div>
    </div>

    <div class="row">
        <!-- 主要信息 -->
        <div class="col-md-8">
            <!-- 原始HTTP接口信息 -->
            <div class="card mb-4" th:if="${httpTool != null}">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-globe me-2"></i>原始HTTP接口信息</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-3">工具编号:</dt>
                        <dd class="col-sm-9" th:text="${httpTool.providerToolNum}">工具编号</dd>

                        <dt class="col-sm-3">名称:</dt>
                        <dd class="col-sm-9" th:text="${httpTool.nameDisplay}">HTTP接口名称</dd>


                        <dt class="col-sm-3">功能描述:</dt>
                        <dd class="col-sm-9" th:text="${httpTool.descDisplay}">HTTP接口描述</dd>

                        <dt class="col-sm-3">输入参数:</dt>
                        <dd class="col-sm-9">
                            <pre th:if="${httpTool.inputSchema != null and !#strings.isEmpty(httpTool.inputSchema)}"
                                 th:text="${httpTool.inputSchema}">输入参数Schema</pre>
                            <span class="text-muted"
                                  th:if="${httpTool.inputSchema == null or httpTool.inputSchema.isEmpty()}">无</span>
                        </dd>

                        <dt class="col-sm-3">输出参数:</dt>
                        <dd class="col-sm-9">
                            <pre th:if="${httpTool.outputSchema != null and !#strings.isEmpty(httpTool.outputSchema)}"
                                 th:text="${httpTool.outputSchema}">输出参数Schema</pre>
                            <span class="text-muted"
                                  th:if="${httpTool.outputSchema == null or httpTool.outputSchema.isEmpty()}">无</span>
                        </dd>

                        <dt class="col-sm-3">服务方app:</dt>
                        <dd class="col-sm-9" th:text="${httpTool.providerAppNum}">服务方app编号</dd>

                        <dt class="col-sm-3">请求url:</dt>
                        <dd class="col-sm-9">
                            <code th:text="${httpTool.reqUrl}">http://example.com</code>
                        </dd>

                        <dt class="col-sm-3">请求方式:</dt>
                        <dd class="col-sm-9">
                            <span class="badge bg-info" th:text="${httpTool.reqMethod}">GET</span>
                        </dd>

                        <dt class="col-sm-3">请求头:</dt>
                        <dd class="col-sm-9">
                            <pre th:if="${httpTool != null and httpTool.reqHeaders != null and httpTool.reqHeaders.length() > 0}"
                                 th:text="${httpTool.reqHeaders}">请求头信息</pre>
                            <span class="text-muted"
                                  th:if="${httpTool == null or httpTool.reqHeaders == null or httpTool.reqHeaders.length() == 0}">无</span>
                        </dd>
                    </dl>
                </div>
            </div>

            <!-- 原始Expo接口信息 -->
            <div class="card mb-4" th:if="${expoTool != null}">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-server me-2"></i>原始Expo接口信息</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-3">工具编号:</dt>
                        <dd class="col-sm-9" th:text="${expoTool.providerToolNum}">工具编号</dd>

                        <dt class="col-sm-3">名称:</dt>
                        <dd class="col-sm-9" th:text="${expoTool.nameDisplay}">Expo接口名称</dd>

                        <dt class="col-sm-3">功能描述:</dt>
                        <dd class="col-sm-9" th:text="${expoTool.descDisplay}">Expo接口描述</dd>

                        <dt class="col-sm-3">提供者工具名称:</dt>
                        <dd class="col-sm-9" th:text="${expoTool.providerToolName}">提供者工具名称</dd>

                        <dt class="col-sm-3">API定义(XML):</dt>
                        <dd class="col-sm-9">
                            <pre th:if="${expoTool.expoApiDefine != null and !#strings.isEmpty(expoTool.expoApiDefine)}"
                                 th:text="${expoTool.expoApiDefine}">Expo API定义</pre>
                            <span class="text-muted"
                                  th:if="${expoTool.expoApiDefine == null or expoTool.expoApiDefine.isEmpty()}">无</span>
                        </dd>

                        <dt class="col-sm-3">服务方app:</dt>
                        <dd class="col-sm-9" th:text="${expoTool.providerAppNum}">服务方app编号</dd>

                        <dt class="col-sm-3">App Class:</dt>
                        <dd class="col-sm-9">
                            <code th:text="${expoTool.appClass}">App Class</code>
                        </dd>

                        <dt class="col-sm-3">Command ID:</dt>
                        <dd class="col-sm-9">
                            <span class="badge bg-info" th:text="${expoTool.commandId}">Command ID</span>
                        </dd>
                    </dl>
                </div>
            </div>

            <!-- MCP工具信息 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>MCP工具信息</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-3">工具编号:</dt>
                        <dd class="col-sm-9" th:text="${tool.toolNum}">工具编号</dd>

                        <dt class="col-sm-3">工具版本:</dt>
                        <dd class="col-sm-9" th:text="${tool.toolVersion}">工具版本</dd>

                        <dt class="col-sm-3">是否有效:</dt>
                        <dd class="col-sm-9">
                            <span class="badge" th:classappend="${tool.valid == '1' ? 'bg-success' : 'bg-secondary'}"
                                  th:text="${tool.valid == '1' ? '有效' : '无效'}">状态</span>
                        </dd>

                        <dt class="col-sm-3">MCP工具英文名:</dt>
                        <dd class="col-sm-9" th:text="${tool.toolName}">工具名称</dd>

                        <dt class="col-sm-3">MCP工具描述:</dt>
                        <dd class="col-sm-9" th:text="${tool.toolDescription}">工具描述</dd>

                        <dt class="col-sm-3">多语言名称 (英文):</dt>
                        <dd class="col-sm-9" id="nameDisplayEn">-</dd>

                        <dt class="col-sm-3">多语言名称 (中文):</dt>
                        <dd class="col-sm-9" id="nameDisplayZh">-</dd>

                        <dt class="col-sm-3">多语言描述 (英文):</dt>
                        <dd class="col-sm-9" id="descriptionDisplayEn">-</dd>

                        <dt class="col-sm-3">多语言描述 (中文):</dt>
                        <dd class="col-sm-9" id="descriptionDisplayZh">-</dd>

                        <!-- Hidden fields for JavaScript to read -->
                        <input id="nameDisplayJson" th:value="${tool.nameDisplay}" type="hidden">
                        <input id="descriptionDisplayJson" th:value="${tool.descriptionDisplay}" type="hidden">

                        <dt class="col-sm-3">input_json_schema:</dt>
                        <dd class="col-sm-9">
                            <div class="schema-box"
                                 th:if="${tool.inputSchema != null and !#strings.isEmpty(tool.inputSchema)}">
                                <div class="schema-header" onclick="toggleSchema('inputSchema', this)">
                                    <span class="schema-title">Input Schema</span>
                                    <i class="fas fa-chevron-down schema-icon"></i>
                                </div>
                                <div class="schema-content collapsed" id="inputSchemaContent">
                                    <pre class="schema-pre" th:text="${tool.inputSchema}">输入Schema</pre>
                                </div>
                            </div>
                            <span class="text-muted"
                                  th:if="${tool.inputSchema == null or tool.inputSchema.isEmpty()}">无</span>
                        </dd>

                        <dt class="col-sm-3">output_json_schema:</dt>
                        <dd class="col-sm-9">
                            <div class="schema-box"
                                 th:if="${tool.outputSchema != null and !#strings.isEmpty(tool.outputSchema)}">
                                <div class="schema-header" onclick="toggleSchema('outputSchema', this)">
                                    <span class="schema-title">Output Schema</span>
                                    <i class="fas fa-chevron-down schema-icon"></i>
                                </div>
                                <div class="schema-content collapsed" id="outputSchemaContent">
                                    <pre class="schema-pre" th:text="${tool.outputSchema}">输出Schema</pre>
                                </div>
                            </div>
                            <span class="text-muted"
                                  th:if="${tool.outputSchema == null or tool.outputSchema.isEmpty()}">无</span>
                        </dd>

                        <dt class="col-sm-3">是否流式输出:</dt>
                        <dd class="col-sm-9" th:text="${tool.streamOutput == '1' ? '是' : '否'}">流式输出</dd>

                        <dt class="col-sm-3">转换模板类型:</dt>
                        <dd class="col-sm-9">
                            <span class="badge bg-success"
                                  th:if="${tool.convertType != null and (tool.convertType == '1' or tool.convertType.toLowerCase().contains('http'))}">
                                <i class="fas fa-globe me-1"></i>HTTP转换模板
                            </span>
                            <span class="badge bg-primary"
                                  th:if="${tool.convertType != null and (tool.convertType == '2' or tool.convertType.equalsIgnoreCase('expo'))}">
                                <i class="fas fa-server me-1"></i>Expo转换模板
                            </span>
                            <span class="badge bg-warning"
                                  th:if="${tool.convertType != null and (tool.convertType == '3' or tool.convertType.equalsIgnoreCase('manual') or tool.convertType.equalsIgnoreCase('code'))}">
                                <i class="fas fa-code me-1"></i>手动转换模板
                            </span>
                            <span class="badge bg-secondary"
                                  th:if="${tool.convertType == null or (tool.convertType != '1' and tool.convertType != '2' and tool.convertType != '3' and !tool.convertType.toLowerCase().contains('http') and !tool.convertType.equalsIgnoreCase('expo') and !tool.convertType.equalsIgnoreCase('manual') and !tool.convertType.equalsIgnoreCase('code'))}">
                                未知
                            </span>
                        </dd>

                        <dt class="col-sm-3">MCP工具类型:</dt>
                        <dd class="col-sm-9"
                            th:text="${tool.toolType == '1' ? 'tool' : (tool.toolType == '2' ? 'agent' : tool.toolType)}">
                            工具类型
                        </dd>
                    </dl>
                </div>
            </div>

            <!-- HTTP转换模板信息 -->
            <div class="card mb-4" th:if="${httpConverter != null}">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>HTTP转换模板信息</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-3">请求路径:</dt>
                        <dd class="col-sm-9">
                            <code th:text="${httpConverter.reqUrl}">服务方URL</code>
                        </dd>

                        <dt class="col-sm-3">工具编号:</dt>
                        <dd class="col-sm-9" th:text="${httpConverter.toolNum}">工具编号</dd>

                        <dt class="col-sm-3">工具版本:</dt>
                        <dd class="col-sm-9" th:text="${httpConverter.toolVersion}">工具版本</dd>

                        <dt class="col-sm-3">请求方式:</dt>
                        <dd class="col-sm-9">
                            <span class="badge bg-info" th:text="${httpConverter.reqMethod}">方法</span>
                        </dd>

                        <dt class="col-sm-3">请求头（jinja2）:</dt>
                        <dd class="col-sm-9">
                            <pre th:if="${httpConverter.reqHeaders != null and !#strings.isEmpty(httpConverter.reqHeaders)}"
                                 th:text="${httpConverter.reqHeaders}">请求头</pre>
                            <span class="text-muted"
                                  th:if="${httpConverter.reqHeaders == null or httpConverter.reqHeaders.isEmpty()}">无</span>
                        </dd>

                        <dt class="col-sm-3">请求体（jinja2）:</dt>
                        <dd class="col-sm-9">
                            <pre th:if="${httpConverter.reqBody != null and !#strings.isEmpty(httpConverter.reqBody)}"
                                 th:text="${httpConverter.reqBody}">请求体模板</pre>
                            <span class="text-muted"
                                  th:if="${httpConverter.reqBody == null or httpConverter.reqBody.isEmpty()}">无</span>
                        </dd>

                        <dt class="col-sm-3">响应体（jinja2）:</dt>
                        <dd class="col-sm-9">
                            <pre th:if="${httpConverter.respBody != null and !#strings.isEmpty(httpConverter.respBody)}"
                                 th:text="${httpConverter.respBody}">响应体模板</pre>
                            <span class="text-muted"
                                  th:if="${httpConverter.respBody == null or httpConverter.respBody.isEmpty()}">无</span>
                        </dd>

                        <dt class="col-sm-3">提供者工具编号:</dt>
                        <dd class="col-sm-9" th:text="${httpConverter.providerToolNum}">提供者工具编号</dd>
                    </dl>
                </div>
            </div>

            <!-- Expo转换模板信息 -->
            <div class="card mb-4" th:if="${expoConverter != null}">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>Expo转换模板信息</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-3">工具编号:</dt>
                        <dd class="col-sm-9" th:text="${expoConverter.toolNum}">工具编号</dd>

                        <dt class="col-sm-3">工具版本:</dt>
                        <dd class="col-sm-9" th:text="${expoConverter.toolVersion}">工具版本</dd>

                        <dt class="col-sm-3">App Class:</dt>
                        <dd class="col-sm-9">
                            <span class="badge bg-info" th:text="${expoConverter.appClass}">App Class</span>
                        </dd>

                        <dt class="col-sm-3">Command ID:</dt>
                        <dd class="col-sm-9">
                            <span class="badge bg-info" th:text="${expoConverter.commandId}">Command ID</span>
                        </dd>

                        <dt class="col-sm-3">输入参数（jinja2）:</dt>
                        <dd class="col-sm-9">
                            <pre th:if="${expoConverter.inputArgs != null and !#strings.isEmpty(expoConverter.inputArgs)}"
                                 th:text="${expoConverter.inputArgs}">输入参数模板</pre>
                            <span class="text-muted"
                                  th:if="${expoConverter.inputArgs == null or expoConverter.inputArgs.isEmpty()}">无</span>
                        </dd>

                        <dt class="col-sm-3">输出参数（jinja2）:</dt>
                        <dd class="col-sm-9">
                            <pre th:if="${expoConverter.outputArgs != null and !#strings.isEmpty(expoConverter.outputArgs)}"
                                 th:text="${expoConverter.outputArgs}">输出参数模板</pre>
                            <span class="text-muted"
                                  th:if="${expoConverter.outputArgs == null or expoConverter.outputArgs.isEmpty()}">无</span>
                        </dd>

                        <dt class="col-sm-3">提供者工具编号:</dt>
                        <dd class="col-sm-9" th:text="${expoConverter.providerToolNum}">提供者工具编号</dd>
                    </dl>
                </div>
            </div>

            <!-- Missing data warnings - HTTP type -->
            <div class="alert alert-warning"
                 th:if="${tool.convertType != null and (tool.convertType == '1' or tool.convertType.toLowerCase().contains('http')) and httpTool == null and httpConverter == null}">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>提示:</strong> 该MCP工具缺少关联的原始HTTP接口和HTTP转换模板信息。
            </div>
            <div class="alert alert-warning"
                 th:if="${tool.convertType != null and (tool.convertType == '1' or tool.convertType.toLowerCase().contains('http')) and httpTool == null and httpConverter != null}">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>提示:</strong> 该MCP工具缺少关联的原始HTTP接口信息。
            </div>
            <div class="alert alert-warning"
                 th:if="${tool.convertType != null and (tool.convertType == '1' or tool.convertType.toLowerCase().contains('http')) and httpTool != null and httpConverter == null}">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>提示:</strong> 该MCP工具缺少关联的HTTP转换模板信息。
            </div>

            <!-- Missing data warnings - Expo type -->
            <div class="alert alert-warning"
                 th:if="${tool.convertType != null and (tool.convertType == '2' or tool.convertType.equalsIgnoreCase('expo')) and expoTool == null and expoConverter == null}">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>提示:</strong> 该MCP工具缺少关联的原始Expo接口和Expo转换模板信息。
            </div>
            <div class="alert alert-warning"
                 th:if="${tool.convertType != null and (tool.convertType == '2' or tool.convertType.equalsIgnoreCase('expo')) and expoTool == null and expoConverter != null}">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>提示:</strong> 该MCP工具缺少关联的原始Expo接口信息。
            </div>
            <div class="alert alert-warning"
                 th:if="${tool.convertType != null and (tool.convertType == '2' or tool.convertType.equalsIgnoreCase('expo')) and expoTool != null and expoConverter == null}">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>提示:</strong> 该MCP工具缺少关联的Expo转换模板信息。
            </div>

            <!-- Missing data warnings - Manual/Code type -->
            <div class="alert alert-info"
                 th:if="${tool.convertType != null and (tool.convertType == '3' or tool.convertType.equalsIgnoreCase('manual') or tool.convertType.equalsIgnoreCase('code'))}">
                <i class="fas fa-info-circle me-2"></i>
                <strong>提示:</strong> 该MCP工具使用手动转换模板,直接通过代码实现,无需额外的转换器配置。
            </div>

            <!-- Missing data warnings - Unknown type or missing convertType -->
            <div class="alert alert-warning"
                 th:if="${tool.convertType == null or (tool.convertType != '1' and tool.convertType != '2' and tool.convertType != '3' and !tool.convertType.toLowerCase().contains('http') and !tool.convertType.equalsIgnoreCase('expo') and !tool.convertType.equalsIgnoreCase('manual') and !tool.convertType.equalsIgnoreCase('code'))}">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>提示:</strong> 该MCP工具的转换模板类型未设置或无效,请检查convertType字段。
            </div>
        </div>

        <!-- 侧边栏信息 -->
        <div class="col-md-4">
            <!-- 基本信息 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info me-2"></i>基本信息</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">工具ID:</dt>
                        <dd class="col-sm-8" th:text="${tool.id}">1</dd>

                        <dt class="col-sm-4">工具编号:</dt>
                        <dd class="col-sm-8" th:text="${tool.toolNum}">工具编号</dd>

                        <dt class="col-sm-4">工具版本:</dt>
                        <dd class="col-sm-8" th:text="${tool.toolVersion}">版本号</dd>

                        <dt class="col-sm-4">创建时间:</dt>
                        <dd class="col-sm-8" th:text="${#temporals.format(tool.createTime, 'yyyy-MM-dd HH:mm:ss')}">
                            2024-01-01 12:00:00
                        </dd>

                        <dt class="col-sm-4" th:if="${tool.createBy}">创建者:</dt>
                        <dd class="col-sm-8" th:if="${tool.createBy}" th:text="${tool.createBy}">创建者</dd>

                        <dt class="col-sm-4" th:if="${tool.updateTime}">更新时间:</dt>
                        <dd class="col-sm-8" th:if="${tool.updateTime}"
                            th:text="${#temporals.format(tool.updateTime, 'yyyy-MM-dd HH:mm:ss')}">2024-01-01 12:00:00
                        </dd>

                        <dt class="col-sm-4" th:if="${tool.updateBy}">更新者:</dt>
                        <dd class="col-sm-8" th:if="${tool.updateBy}" th:text="${tool.updateBy}">更新者</dd>
                    </dl>
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-tools me-2"></i>操作</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a class="btn btn-primary" th:href="@{/mcp-tools/edit/{id}(id=${tool.id})}">
                            <i class="fas fa-edit me-1"></i>编辑工具
                        </a>
                        <button class="btn btn-danger" onclick="confirmDelete([[${tool.id}]], '[[${tool.toolName}]]')"
                                type="button">
                            <i class="fas fa-trash me-1"></i>删除工具
                        </button>
                        <button class="btn btn-success" th:onclick="|testTool(${tool.id})|" type="button">
                            <i class="fas fa-vial me-1"></i>测试工具
                        </button>
                        <button class="btn btn-info" th:onclick="|exportTool(${tool.id})|" type="button">
                            <i class="fas fa-download me-1"></i>导出工具
                        </button>
                        <button class="btn btn-warning"
                                th:if="${session.currentProvider != null and session.currentProvider.username == 'pczhou'}"
                                th:onclick="|publishTool(${tool.id})|"
                                type="button">
                            <i class="fas fa-cloud-upload-alt me-1"></i>发布工具
                        </button>
                        <a class="btn btn-outline-secondary" th:href="@{/mcp-tools}">
                            <i class="fas fa-list me-1"></i>返回列表
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <p>确定要删除工具 "<span id="deleteToolName"></span>" 吗？</p>
                <p class="text-danger">此操作不可撤销！</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">取消</button>
                <button class="btn btn-danger" id="confirmDeleteBtn" type="button">确认删除</button>
            </div>
        </div>
    </div>
</div>

<!-- 测试工具模态框 -->
<div class="modal fade" id="testParamsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-vial me-2"></i>测试工具</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <!-- 1. 参数输入框 -->
                <div class="mb-4">
                    <label class="form-label fw-bold">
                        <i class="fas fa-keyboard me-1"></i>参数输入:
                    </label>
                    <textarea class="form-control font-monospace" id="testParamsJson"
                              placeholder="请输入JSON格式的测试参数,例如: {&quot;name&quot;: &quot;test&quot;, &quot;value&quot;: 123}"
                              rows="6">{}</textarea>
                </div>

                <!-- 2. wind.sessionid输入框 -->
                <div class="mb-4">
                    <label class="form-label fw-bold" for="windSessionId">
                        <i class="fas fa-key me-1"></i>wind.sessionid:
                    </label>
                    <input class="form-control font-monospace" id="windSessionId"
                           placeholder="请输入wind.sessionid"
                           type="text">
                </div>

                <!-- 3. 发起测试按钮 -->
                <div class="mb-4 text-center">
                    <button class="btn btn-primary btn-lg" onclick="executeTest()" type="button">
                        <i class="fas fa-play me-2"></i>发起测试
                    </button>
                </div>

                <!-- 4. 输出参数框 (测试结果) -->
                <div>
                    <label class="form-label fw-bold">
                        <i class="fas fa-terminal me-1"></i>测试结果:
                    </label>
                    <div class="border rounded p-3 bg-light" id="testResultOutput"
                         style="min-height: 200px; max-height: 400px; overflow-y: auto;">
                        <div class="text-muted text-center py-5">
                            <i class="fas fa-info-circle me-2"></i>等待测试...
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" disabled id="confirmTestSuccessBtn" type="button">
                    <i class="fas fa-check-circle me-1"></i>确认测试成功
                </button>
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">
                    <i class="fas fa-times me-1"></i>关闭
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 测试结果模态框 -->
<div class="modal fade" id="testResultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-vial me-2"></i>工具测试结果</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <div id="testResultContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">测试中...</span>
                        </div>
                        <p class="mt-3">正在执行测试,请稍候...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 自定义样式 -->
<style>
    /* Schema容器样式 */
    .schema-box {
        width: 100%;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        overflow: hidden;
        background-color: #fff;
    }

    .schema-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        cursor: pointer;
        user-select: none;
        transition: background 0.2s ease;
    }

    .schema-header:hover {
        background: linear-gradient(135deg, #5568d3 0%, #6a4190 100%);
    }

    .schema-header:active {
        background: linear-gradient(135deg, #4c5fc7 0%, #5e3a82 100%);
    }

    .schema-title {
        font-weight: 600;
        font-size: 0.9rem;
        letter-spacing: 0.5px;
    }

    .schema-icon {
        transition: transform 0.3s ease;
        font-size: 1rem;
    }

    .schema-header.expanded .schema-icon {
        transform: rotate(180deg);
    }

    .schema-content {
        transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
        overflow: hidden;
        background-color: #f8f9fa;
    }

    .schema-content.collapsed {
        max-height: 150px;
        padding: 0.5rem 1rem;
    }

    .schema-content.expanded {
        max-height: 600px;
        padding: 1rem;
        overflow-y: auto;
    }

    .schema-pre {
        background-color: transparent;
        border: none;
        border-radius: 0;
        padding: 0;
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: 'Courier New', Courier, monospace;
        font-size: 0.85rem;
        line-height: 1.6;
        color: #2d3748;
    }

    /* 滚动条样式 */
    .schema-content.expanded::-webkit-scrollbar {
        width: 8px;
    }

    .schema-content.expanded::-webkit-scrollbar-track {
        background: #e2e8f0;
        border-radius: 4px;
    }

    .schema-content.expanded::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 4px;
    }

    .schema-content.expanded::-webkit-scrollbar-thumb:hover {
        background: #5568d3;
    }
</style>

<!-- Bootstrap JS -->
<script src="/js/bootstrap.bundle.min.js"></script>
<!-- Prism.js for code highlighting -->
<script src="/vendor/prism/prism-core-1.24.1.min.js"></script>
<script src="/vendor/prism/prism-autoloader-1.24.1.min.js"></script>
<!-- 工具测试功能 -->
<script src="/js/tool-test.js"></script>

<script>
    let currentToolId = null;

    /**
     * 解析多语言JSON字段并显示
     */
    function parseMultilingualFields() {
        // 解析nameDisplay
        const nameDisplayJson = document.getElementById('nameDisplayJson');
        if (nameDisplayJson && nameDisplayJson.value) {
            try {
                const nameData = JSON.parse(nameDisplayJson.value);
                document.getElementById('nameDisplayEn').textContent = nameData.en || '-';
                document.getElementById('nameDisplayZh').textContent = nameData.zh || '-';
            } catch (e) {
                console.error('Failed to parse nameDisplay JSON:', e);
                document.getElementById('nameDisplayEn').textContent = nameDisplayJson.value;
                document.getElementById('nameDisplayZh').textContent = '-';
            }
        }

        // 解析descriptionDisplay
        const descriptionDisplayJson = document.getElementById('descriptionDisplayJson');
        if (descriptionDisplayJson && descriptionDisplayJson.value) {
            try {
                const descData = JSON.parse(descriptionDisplayJson.value);
                document.getElementById('descriptionDisplayEn').textContent = descData.en || '-';
                document.getElementById('descriptionDisplayZh').textContent = descData.zh || '-';
            } catch (e) {
                console.error('Failed to parse descriptionDisplay JSON:', e);
                document.getElementById('descriptionDisplayEn').textContent = descriptionDisplayJson.value;
                document.getElementById('descriptionDisplayZh').textContent = '-';
            }
        }
    }

    // 页面加载时执行
    document.addEventListener('DOMContentLoaded', parseMultilingualFields);

    /**
     * 切换Schema内容的展开/收起状态
     * @param {string} schemaType - Schema类型 ('inputSchema' 或 'outputSchema')
     * @param {HTMLElement} headerElement - 被点击的header元素
     */
    function toggleSchema(schemaType, headerElement) {
        const content = document.getElementById(schemaType + 'Content');

        if (!content || !headerElement) {
            return;
        }

        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            content.classList.add('expanded');
            headerElement.classList.add('expanded');
        } else {
            content.classList.remove('expanded');
            content.classList.add('collapsed');
            headerElement.classList.remove('expanded');
        }
    }

    function confirmDelete(toolId, toolName) {
        currentToolId = toolId;
        document.getElementById('deleteToolName').textContent = toolName;
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }

    // 处理删除确认
    document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
        if (!currentToolId) return;

        const btn = this;
        const originalText = btn.innerHTML;

        // 显示加载状态
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>删除中...';
        btn.disabled = true;

        // 发送删除请求
        fetch(`/mcp-tools/delete/${currentToolId}`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (response.ok) {
                    // 删除成功，显示成功消息并跳转
                    btn.innerHTML = '<i class="fas fa-check me-1"></i>删除成功';
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-success');

                    setTimeout(() => {
                        // 跳转到工具列表页面
                        window.location.href = '/mcp-tools?success=工具删除成功';
                    }, 1000);
                } else {
                    throw new Error('删除失败');
                }
            })
            .catch(error => {
                console.error('删除失败:', error);
                alert('删除失败，请稍后重试');

                // 恢复按钮状态
                btn.innerHTML = originalText;
                btn.disabled = false;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-danger');
            });
    });

    function copyConfig() {
        const configElement = document.getElementById('toolConfig');
        const text = configElement.textContent;

        navigator.clipboard.writeText(text).then(function () {
            // 显示复制成功提示
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check me-1"></i>已复制';
            button.classList.remove('btn-outline-secondary');
            button.classList.add('btn-success');

            setTimeout(function () {
                button.innerHTML = originalText;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-secondary');
            }, 2000);
        }).catch(function (err) {
            console.error('复制失败: ', err);
        });
    }

    /**
     * 导出工具信息为JSON文件
     * @param {number} toolId - 工具ID
     */
    function exportTool(toolId) {
        if (!toolId) {
            alert('工具ID不能为空');
            return;
        }

        console.log('[导出工具] 开始导出, 工具ID:', toolId);

        // 发送导出请求
        fetch(`/mcp-tools/api/export/${toolId}`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                // 获取文件名(从响应头中提取,如果有的话)
                const contentDisposition = response.headers.get('Content-Disposition');
                let fileName = 'mcp-tool-export.json';
                if (contentDisposition) {
                    const matches = /filename="?([^"]+)"?/.exec(contentDisposition);
                    if (matches && matches[1]) {
                        fileName = matches[1];
                    }
                }
                console.log('[导出工具] 文件名:', fileName);

                return response.json().then(data => ({data, fileName}));
            })
            .then(({data, fileName}) => {
                console.log('[导出工具] 成功获取数据:', data);

                // 将JSON数据转换为字符串
                const jsonStr = JSON.stringify(data, null, 2);

                // 创建Blob对象
                const blob = new Blob([jsonStr], {type: 'application/json'});

                // 创建下载链接
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;

                // 触发下载
                document.body.appendChild(a);
                a.click();

                // 清理
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                console.log('[导出工具] 下载完成');
            })
            .catch(error => {
                console.error('[导出工具] 失败:', error);
                alert('导出失败: ' + error.message);
            });
    }

    /**
     * 发布工具到目标数据库 (wind_mcp_server)
     * @param {number} toolId - 工具ID
     */
    function publishTool(toolId) {
        if (!toolId) {
            alert('工具ID不能为空');
            return;
        }

        // 确认发布
        if (!confirm('确定要将此工具发布到wind_mcp_server数据库吗?')) {
            return;
        }

        console.log('[发布工具] 开始发布, 工具ID:', toolId);

        // 显示加载提示
        const loadingToast = showToast('正在发布工具...', 'info', 0);

        // 1. 先导出工具数据
        fetch(`/mcp-tools/api/export/${toolId}`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`导出失败: HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(exportData => {
                console.log('[发布工具] 导出数据成功:', exportData);

                // 2. 构建发布DTO
                const publishDto = buildPublishDto(exportData);
                console.log('[发布工具] 发布DTO:', publishDto);

                // 3. 发送发布请求
                return fetch('/mcp-tools/api/publish', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(publishDto)
                });
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.message || `HTTP ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(result => {
                console.log('[发布工具] 发布成功:', result);
                hideToast(loadingToast);
                showToast('工具发布成功!', 'success', 3000);
            })
            .catch(error => {
                console.error('[发布工具] 失败:', error);
                hideToast(loadingToast);
                showToast('发布失败: ' + error.message, 'danger', 5000);
            });
    }

    /**
     * 构建发布DTO对象
     * @param {object} exportData - 导出的工具数据
     * @returns {object} 发布DTO
     */
    function buildPublishDto(exportData) {
        const dto = {};

        // 复制MCP工具基本信息
        if (exportData.mcpTool) {
            const tool = exportData.mcpTool;
            dto.id = tool.id;
            dto.toolNum = tool.toolNum;
            dto.toolVersion = tool.toolVersion;
            dto.valid = tool.valid;
            dto.toolName = tool.toolName;
            dto.toolDescription = tool.toolDescription;
            dto.nameDisplay = tool.nameDisplay;
            dto.descriptionDisplay = tool.descriptionDisplay;
            dto.inputSchema = tool.inputSchema;
            dto.outputSchema = tool.outputSchema;
            dto.streamOutput = tool.streamOutput;
            dto.convertType = tool.convertType;
            dto.toolType = tool.toolType;
            dto.providerId = tool.providerId;
        }

        // 复制原始HTTP工具信息
        if (exportData.originToolHttp) {
            const httpTool = exportData.originToolHttp;
            dto.httpReqUrl = httpTool.reqUrl;
            dto.httpReqMethod = httpTool.reqMethod;
            dto.httpReqHeaders = httpTool.reqHeaders;
            dto.httpInputSchema = typeof httpTool.inputSchema === 'string'
                ? httpTool.inputSchema
                : JSON.stringify(httpTool.inputSchema);
            dto.httpOutputSchema = typeof httpTool.outputSchema === 'string'
                ? httpTool.outputSchema
                : JSON.stringify(httpTool.outputSchema);
        }

        // 复制原始Expo工具信息
        if (exportData.originToolExpo) {
            const expoTool = exportData.originToolExpo;
            dto.expoAppClass = expoTool.appClass;
            dto.expoCommandId = expoTool.commandId;
            dto.expoFunctionName = expoTool.functionName;
            dto.expoApiDefine = expoTool.expoApiDefine;
        }

        // 复制HTTP转换模板信息
        if (exportData.httpTemplateConverter) {
            const httpConverter = exportData.httpTemplateConverter;
            dto.httpTemplateReqUrl = httpConverter.reqUrl;
            dto.httpTemplateReqMethod = httpConverter.reqMethod;
            dto.httpTemplateReqHeaders = httpConverter.reqHeaders;
            dto.httpTemplateReqBody = httpConverter.reqBody;
            dto.httpTemplateRespBody = httpConverter.respBody;
        }

        // 复制Expo转换模板信息
        if (exportData.expoTemplateConverter) {
            const expoConverter = exportData.expoTemplateConverter;
            dto.expoTemplateAppClass = expoConverter.appClass;
            dto.expoTemplateCommandId = expoConverter.commandId;
            dto.expoTemplateInputArgs = expoConverter.inputArgs;
            dto.expoTemplateOutputArgs = expoConverter.outputArgs;
        }

        return dto;
    }

    /**
     * 显示Toast提示
     * @param {string} message - 消息内容
     * @param {string} type - 类型 (success/danger/warning/info)
     * @param {number} duration - 显示时长(毫秒), 0表示不自动关闭
     * @returns {HTMLElement} Toast元素
     */
    function showToast(message, type = 'info', duration = 3000) {
        const toastContainer = getOrCreateToastContainer();

        const toastId = 'toast-' + Date.now();
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = `alert alert-${type} alert-dismissible fade show`;
        toast.role = 'alert';
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        toastContainer.appendChild(toast);

        if (duration > 0) {
            setTimeout(() => hideToast(toast), duration);
        }

        return toast;
    }

    /**
     * 隐藏Toast
     * @param {HTMLElement} toast - Toast元素
     */
    function hideToast(toast) {
        if (toast && toast.parentNode) {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 150);
        }
    }

    /**
     * 获取或创建Toast容器
     * @returns {HTMLElement} Toast容器
     */
    function getOrCreateToastContainer() {
        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 350px;';
            document.body.appendChild(container);
        }
        return container;
    }
</script>
</body>
</html>