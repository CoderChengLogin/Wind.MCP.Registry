<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title th:text="${tool.toolName} + ' - MCP工具注册中心'">工具详情 - MCP工具注册中心</title>

    <!-- Bootstrap CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="/css/all.min.css" rel="stylesheet">
    <!-- Prism.js for code highlighting -->
    <link href="/vendor/prism/prism-1.24.1.min.css" rel="stylesheet">
    <!-- 自定义CSS -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<!-- 导航栏 -->
<nav th:replace="~{fragments/navigation :: navbar}"></nav>

<!-- 主要内容区域 -->
<main class="container mt-4">
    <!-- 面包屑导航 -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/}">首页</a></li>
            <li class="breadcrumb-item"><a th:href="@{/mcp-tools}">MCP工具</a></li>
            <li class="breadcrumb-item active" th:text="${tool.toolName}">工具详情</li>
        </ol>
    </nav>

    <!-- 工具标题和操作 -->
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h1 class="mb-2">
                <i class="fas fa-cogs me-2"></i>
                <span th:text="${tool.toolName}">工具名称</span>
            </h1>
            <div class="mb-2">
                    <span class="badge me-2"
                          th:classappend="${tool.valid == '1' ? 'bg-success' : 'bg-secondary'}"
                          th:text="${tool.valid == '1' ? '有效' : '无效'}">状态</span>
                <span class="badge bg-info me-2" th:if="${tool.toolType}"
                      th:text="${tool.toolType == '1' ? 'tool' : (tool.toolType == '2' ? 'agent' : tool.toolType)}">类型</span>
                <span class="badge bg-secondary" th:if="${tool.toolVersion}"
                      th:text="'v' + ${tool.toolVersion}">版本</span>
            </div>
        </div>

        <div class="btn-group" role="group">
            <a class="btn btn-outline-primary" th:href="@{/mcp-tools/edit/{id}(id=${tool.id})}">
                <i class="fas fa-edit me-1"></i>编辑
            </a>
            <a class="btn btn-outline-secondary" th:href="@{/mcp-tools}">
                <i class="fas fa-arrow-left me-1"></i>返回列表
            </a>
        </div>
    </div>

    <div class="row">
        <!-- 主要信息 -->
        <div class="col-md-8">
            <!-- 原始HTTP接口信息 -->
            <div class="card mb-4" th:if="${httpTool != null}">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-globe me-2"></i>原始HTTP接口信息</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-3">工具编号:</dt>
                        <dd class="col-sm-9" th:text="${httpTool.providerToolNum}">工具编号</dd>

                        <dt class="col-sm-3">名称:</dt>
                        <dd class="col-sm-9" th:text="${httpTool.nameDisplay}">HTTP接口名称</dd>


                        <dt class="col-sm-3">功能描述:</dt>
                        <dd class="col-sm-9" th:text="${httpTool.descDisplay}">HTTP接口描述</dd>

                        <dt class="col-sm-3">输入参数:</dt>
                        <dd class="col-sm-9">
                            <pre th:if="${httpTool.inputSchema != null and !#strings.isEmpty(httpTool.inputSchema)}"
                                 th:text="${httpTool.inputSchema}">输入参数Schema</pre>
                            <span class="text-muted"
                                  th:if="${httpTool.inputSchema == null or httpTool.inputSchema.isEmpty()}">无</span>
                        </dd>

                        <dt class="col-sm-3">输出参数:</dt>
                        <dd class="col-sm-9">
                            <pre th:if="${httpTool.outputSchema != null and !#strings.isEmpty(httpTool.outputSchema)}"
                                 th:text="${httpTool.outputSchema}">输出参数Schema</pre>
                            <span class="text-muted"
                                  th:if="${httpTool.outputSchema == null or httpTool.outputSchema.isEmpty()}">无</span>
                        </dd>

                        <dt class="col-sm-3">服务方app:</dt>
                        <dd class="col-sm-9" th:text="${httpTool.providerAppNum}">服务方app编号</dd>

                        <dt class="col-sm-3">请求url:</dt>
                        <dd class="col-sm-9">
                            <code th:text="${httpTool.reqUrl}">http://example.com</code>
                        </dd>

                        <dt class="col-sm-3">请求方式:</dt>
                        <dd class="col-sm-9">
                            <span class="badge bg-info" th:text="${httpTool.reqMethod}">GET</span>
                        </dd>

                        <dt class="col-sm-3">请求头:</dt>
                        <dd class="col-sm-9">
                            <pre th:if="${httpTool != null and httpTool.reqHeaders != null and httpTool.reqHeaders.length() > 0}"
                                 th:text="${httpTool.reqHeaders}">请求头信息</pre>
                            <span class="text-muted"
                                  th:if="${httpTool == null or httpTool.reqHeaders == null or httpTool.reqHeaders.length() == 0}">无</span>
                        </dd>
                    </dl>
                </div>
            </div>

            <!-- MCP工具信息 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>MCP工具信息</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-3">工具编号:</dt>
                        <dd class="col-sm-9" th:text="${tool.toolNum}">工具编号</dd>

                        <dt class="col-sm-3">工具版本:</dt>
                        <dd class="col-sm-9" th:text="${tool.toolVersion}">工具版本</dd>

                        <dt class="col-sm-3">valid:</dt>
                        <dd class="col-sm-9">
                            <span class="badge" th:classappend="${tool.valid == '1' ? 'bg-success' : 'bg-secondary'}"
                                  th:text="${tool.valid == '1' ? '有效' : '无效'}">状态</span>
                        </dd>

                        <dt class="col-sm-3">MCP工具英文名:</dt>
                        <dd class="col-sm-9" th:text="${tool.toolName}">工具名称</dd>

                        <dt class="col-sm-3">MCP工具描述:</dt>
                        <dd class="col-sm-9" th:text="${tool.toolDescription}">工具描述</dd>

                        <dt class="col-sm-3">多语言名称:</dt>
                        <dd class="col-sm-9" th:text="${tool.nameDisplay}">显示名称</dd>

                        <dt class="col-sm-3">多语言描述:</dt>
                        <dd class="col-sm-9" th:text="${tool.descriptionDisplay}">显示描述</dd>

                        <dt class="col-sm-3">input_json_schema:</dt>
                        <dd class="col-sm-9">
                            <pre th:if="${tool.inputSchema != null and !#strings.isEmpty(tool.inputSchema)}"
                                 th:text="${tool.inputSchema}">输入Schema</pre>
                            <span class="text-muted"
                                  th:if="${tool.inputSchema == null or tool.inputSchema.isEmpty()}">无</span>
                        </dd>

                        <dt class="col-sm-3">output_json_schema:</dt>
                        <dd class="col-sm-9">
                            <pre th:if="${tool.outputSchema != null and !#strings.isEmpty(tool.outputSchema)}"
                                 th:text="${tool.outputSchema}">输出Schema</pre>
                            <span class="text-muted"
                                  th:if="${tool.outputSchema == null or tool.outputSchema.isEmpty()}">无</span>
                        </dd>

                        <dt class="col-sm-3">是否流式输出:</dt>
                        <dd class="col-sm-9" th:text="${tool.streamOutput == '1' ? '是' : '否'}">流式输出</dd>

                        <dt class="col-sm-3">转换模板类型:</dt>
                        <dd class="col-sm-9" th:text="${tool.convertType == '1' ? 'HTTP工具' : '其他'}">转换类型</dd>

                        <dt class="col-sm-3">MCP工具类型:</dt>
                        <dd class="col-sm-9"
                            th:text="${tool.toolType == '1' ? 'tool' : (tool.toolType == '2' ? 'agent' : tool.toolType)}">
                            工具类型
                        </dd>
                    </dl>
                </div>
            </div>

            <!-- HTTP转换模板信息 -->
            <div class="card mb-4" th:if="${converter != null}">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>HTTP转换模板信息</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-3">请求路径:</dt>
                        <dd class="col-sm-9">
                            <code th:text="${converter.reqUrl}">服务方URL</code>
                        </dd>

                        <dt class="col-sm-3">工具编号:</dt>
                        <dd class="col-sm-9" th:text="${converter.toolNum}">工具编号</dd>

                        <dt class="col-sm-3">工具版本:</dt>
                        <dd class="col-sm-9" th:text="${converter.toolVersion}">工具版本</dd>


                        <dt class="col-sm-3">请求方式:</dt>
                        <dd class="col-sm-9">
                            <span class="badge bg-info" th:text="${converter.reqMethod}">方法</span>
                        </dd>

                        <dt class="col-sm-3">请求头（jinja2）:</dt>
                        <dd class="col-sm-9">
                            <pre th:if="${converter.reqHeaders != null and !#strings.isEmpty(converter.reqHeaders)}"
                                 th:text="${converter.reqHeaders}">请求头</pre>
                            <span class="text-muted"
                                  th:if="${converter.reqHeaders == null or converter.reqHeaders.isEmpty()}">无</span>
                        </dd>

                        <dt class="col-sm-3">请求体（jinja2）:</dt>
                        <dd class="col-sm-9">
                            <pre th:if="${converter.reqBody != null and !#strings.isEmpty(converter.reqBody)}"
                                 th:text="${converter.reqBody}">请求体模板</pre>
                            <span class="text-muted"
                                  th:if="${converter.reqBody == null or converter.reqBody.isEmpty()}">无</span>
                        </dd>

                        <dt class="col-sm-3">响应体（jinja2）:</dt>
                        <dd class="col-sm-9">
                            <pre th:if="${converter.respBody != null and !#strings.isEmpty(converter.respBody)}"
                                 th:text="${converter.respBody}">响应体模板</pre>
                            <span class="text-muted"
                                  th:if="${converter.respBody == null or converter.respBody.isEmpty()}">无</span>
                        </dd>

                        <dt class="col-sm-3">提供者工具编号:</dt>
                        <dd class="col-sm-9" th:text="${converter.providerToolNum}">提供者工具编号</dd>
                    </dl>
                </div>
            </div>

            <!-- 缺失数据提示 -->
            <div class="alert alert-warning" th:if="${httpTool == null and converter == null}">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>提示:</strong> 该MCP工具缺少关联的原始HTTP接口和转换模板信息。
            </div>
            <div class="alert alert-warning" th:if="${httpTool == null and converter != null}">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>提示:</strong> 该MCP工具缺少关联的原始HTTP接口信息。
            </div>
            <div class="alert alert-warning" th:if="${httpTool != null and converter == null}">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>提示:</strong> 该MCP工具缺少关联的转换模板信息。
            </div>
        </div>

        <!-- 侧边栏信息 -->
        <div class="col-md-4">
            <!-- 基本信息 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info me-2"></i>基本信息</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">工具ID:</dt>
                        <dd class="col-sm-8" th:text="${tool.id}">1</dd>

                        <dt class="col-sm-4">工具编号:</dt>
                        <dd class="col-sm-8" th:text="${tool.toolNum}">工具编号</dd>

                        <dt class="col-sm-4">工具版本:</dt>
                        <dd class="col-sm-8" th:text="${tool.toolVersion}">版本号</dd>

                        <dt class="col-sm-4">创建时间:</dt>
                        <dd class="col-sm-8" th:text="${#temporals.format(tool.createTime, 'yyyy-MM-dd HH:mm:ss')}">
                            2024-01-01 12:00:00
                        </dd>

                        <dt class="col-sm-4" th:if="${tool.createBy}">创建者:</dt>
                        <dd class="col-sm-8" th:if="${tool.createBy}" th:text="${tool.createBy}">创建者</dd>

                        <dt class="col-sm-4" th:if="${tool.updateTime}">更新时间:</dt>
                        <dd class="col-sm-8" th:if="${tool.updateTime}"
                            th:text="${#temporals.format(tool.updateTime, 'yyyy-MM-dd HH:mm:ss')}">2024-01-01 12:00:00
                        </dd>

                        <dt class="col-sm-4" th:if="${tool.updateBy}">更新者:</dt>
                        <dd class="col-sm-8" th:if="${tool.updateBy}" th:text="${tool.updateBy}">更新者</dd>
                    </dl>
                </div>
            </div>

            <!-- JSON Schema信息 -->
            <div class="card mb-4" th:if="${tool.inputSchema != null or tool.outputSchema != null}">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-code me-2"></i>Schema信息</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3" th:if="${tool.inputSchema != null}">
                        <h6>输入Schema:</h6>
                        <pre class="bg-light p-2 rounded" style="max-height: 200px; overflow-y: auto;"
                             th:text="${tool.inputSchema}">输入Schema</pre>
                    </div>
                    <div th:if="${tool.outputSchema != null}">
                        <h6>输出Schema:</h6>
                        <pre class="bg-light p-2 rounded" style="max-height: 200px; overflow-y: auto;"
                             th:text="${tool.outputSchema}">输出Schema</pre>
                    </div>
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-tools me-2"></i>操作</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a class="btn btn-primary" th:href="@{/mcp-tools/edit/{id}(id=${tool.id})}">
                            <i class="fas fa-edit me-1"></i>编辑工具
                        </a>
                        <button class="btn btn-danger" onclick="confirmDelete([[${tool.id}]], '[[${tool.toolName}]]')"
                                type="button">
                            <i class="fas fa-trash me-1"></i>删除工具
                        </button>
                        <a class="btn btn-outline-secondary" th:href="@{/mcp-tools}">
                            <i class="fas fa-list me-1"></i>返回列表
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <p>确定要删除工具 "<span id="deleteToolName"></span>" 吗？</p>
                <p class="text-danger">此操作不可撤销！</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">取消</button>
                <button class="btn btn-danger" id="confirmDeleteBtn" type="button">确认删除</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="/js/bootstrap.bundle.min.js"></script>
<!-- Prism.js for code highlighting -->
<script src="/vendor/prism/prism-core-1.24.1.min.js"></script>
<script src="/vendor/prism/prism-autoloader-1.24.1.min.js"></script>

<script>
    let currentToolId = null;

    function confirmDelete(toolId, toolName) {
        currentToolId = toolId;
        document.getElementById('deleteToolName').textContent = toolName;
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }

    // 处理删除确认
    document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
        if (!currentToolId) return;

        const btn = this;
        const originalText = btn.innerHTML;

        // 显示加载状态
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>删除中...';
        btn.disabled = true;

        // 发送删除请求
        fetch(`/mcp-tools/delete/${currentToolId}`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (response.ok) {
                    // 删除成功，显示成功消息并跳转
                    btn.innerHTML = '<i class="fas fa-check me-1"></i>删除成功';
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-success');

                    setTimeout(() => {
                        // 跳转到工具列表页面
                        window.location.href = '/mcp-tools?success=工具删除成功';
                    }, 1000);
                } else {
                    throw new Error('删除失败');
                }
            })
            .catch(error => {
                console.error('删除失败:', error);
                alert('删除失败，请稍后重试');

                // 恢复按钮状态
                btn.innerHTML = originalText;
                btn.disabled = false;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-danger');
            });
    });

    function copyConfig() {
        const configElement = document.getElementById('toolConfig');
        const text = configElement.textContent;

        navigator.clipboard.writeText(text).then(function () {
            // 显示复制成功提示
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check me-1"></i>已复制';
            button.classList.remove('btn-outline-secondary');
            button.classList.add('btn-success');

            setTimeout(function () {
                button.innerHTML = originalText;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-secondary');
            }, 2000);
        }).catch(function (err) {
            console.error('复制失败: ', err);
        });
    }
</script>
</body>
</html>