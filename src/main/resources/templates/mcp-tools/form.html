<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title th:text="${tool.id != null ? '编辑工具 - ' + tool.toolName : '添加新工具'} + ' - MCP工具注册中心'">添加新工具
        -
        MCP工具注册中心</title>
    <link href="/vendor/bootstrap/bootstrap-5.3.0.min.css" rel="stylesheet">
    <link href="/vendor/fontawesome/all-6.4.0.min.css" rel="stylesheet">
    <style>
        .navbar-brand {
            font-weight: bold;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .required {
            color: #dc3545;
        }

        .json-editor {
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
<!-- 导航栏 -->
<nav th:replace="~{fragments/navigation :: navbar}"></nav>

<div class="container mt-4">
    <!-- 面包屑导航 -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">首页</a></li>
            <li class="breadcrumb-item"><a href="/mcp-tools">MCP工具</a></li>
            <li class="breadcrumb-item active" th:text="${tool.id != null ? '编辑工具' : '添加新工具'}">添加新工具</li>
        </ol>
    </nav>

    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="fas fa-cogs me-2"></i>
            <span th:text="${tool.id != null ? '编辑MCP工具' : '添加新MCP工具'}">添加新MCP工具</span>
        </h1>
        <a class="btn btn-outline-secondary" href="/mcp-tools">
            <i class="fas fa-arrow-left me-2"></i>返回列表
        </a>
    </div>

    <!-- 工具表单 -->
    <form id="mcpToolForm" method="post" th:action="@{/mcp-tools/api/save}">
        <input th:field="${tool.id}" type="hidden">

        <!-- 基本信息 -->
        <div class="form-section">
            <h4 class="mb-3"><i class="fas fa-info-circle me-2"></i>基本信息</h4>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="toolName">工具英文名 <span class="required">*</span></label>
                        <input class="form-control" id="toolName" required th:field="${tool.toolName}" type="text">
                        <div class="form-text">请输入工具的英文名称（用于系统识别）</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="toolDescription">工具描述 <span class="required">*</span></label>
                        <textarea class="form-control" id="toolDescription" required rows="3"
                                  th:field="${tool.toolDescription}"></textarea>
                        <div class="form-text">请描述这个工具的功能和用途</div>
                    </div>
                </div>
            </div>

            <!-- 多语言名称 - 拆分为中英文 -->
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="nameDisplayEn">多语言名称 (英文) <span class="required">*</span></label>
                        <input class="form-control" id="nameDisplayEn"
                               placeholder="Tool Name in English" required type="text">
                        <div class="form-text">工具的英文显示名称</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="nameDisplayZh">多语言名称 (中文) <span class="required">*</span></label>
                        <input class="form-control" id="nameDisplayZh"
                               placeholder="工具中文名称" required type="text">
                        <div class="form-text">工具的中文显示名称</div>
                    </div>
                </div>
            </div>

            <!-- 多语言描述 - 拆分为中英文 -->
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="descriptionDisplayEn">多语言描述 (英文) <span
                                class="required">*</span></label>
                        <textarea class="form-control" id="descriptionDisplayEn"
                                  placeholder="Tool description in English" required rows="3"></textarea>
                        <div class="form-text">工具的英文显示描述</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="descriptionDisplayZh">多语言描述 (中文) <span
                                class="required">*</span></label>
                        <textarea class="form-control" id="descriptionDisplayZh"
                                  placeholder="工具中文描述" required rows="3"></textarea>
                        <div class="form-text">工具的中文显示描述</div>
                    </div>
                </div>
            </div>

            <!-- Hidden fields for backend compatibility -->
            <input id="nameDisplay" th:field="${tool.nameDisplay}" type="hidden">
            <input id="descriptionDisplay" th:field="${tool.descriptionDisplay}" type="hidden">
        </div>

        <!-- MCP配置 -->
        <div class="form-section">
            <h4 class="mb-3"><i class="fas fa-cog me-2"></i>MCP配置</h4>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="toolType">工具类型 <span class="required">*</span></label>
                        <select class="form-select" id="toolType" required th:field="${tool.toolType}">
                            <option value="">请选择工具类型</option>
                            <option value="1">tool</option>
                            <option value="2">agent</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="streamOutput">是否流式输出 <span
                                class="required">*</span></label>
                        <select class="form-select" id="streamOutput" required th:field="${tool.streamOutput}">
                            <option value="">请选择是否流式输出</option>
                            <option value="0">否</option>
                            <!--                            <option value="1">是</option>-->
                        </select>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="convertType">转换模板类型 <span class="required">*</span></label>
                        <select class="form-select" id="convertType" required th:field="${tool.convertType}">
                            <option value="">请选择转换模板类型</option>
                            <option value="1">HTTP转换模板</option>
                            <option value="2">Expo转换模板</option>
                            <option value="3">手动转换模板</option>
                        </select>
                        <div class="form-text">选择工具的转换模板类型</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="valid">工具状态 <span class="required">*</span></label>
                        <select class="form-select" id="valid" required th:field="${tool.valid}">
                            <option value="">请选择工具状态</option>
                            <option value="1">有效</option>
                            <option value="0">无效</option>
                        </select>
                        <div class="form-text">设置工具是否有效可用</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Schema配置 -->
        <div class="form-section">
            <h4 class="mb-3"><i class="fas fa-sliders-h me-2"></i>输入输出的JSON Schema配置</h4>

            <div class="mb-3">
                <label class="form-label" for="inputSchema">输入Schema (JSON格式) <span
                        class="required">*</span></label>
                <textarea class="form-control json-editor" id="inputSchema"
                          placeholder='{"type": "object", "properties": {...}}'
                          required rows="6"
                          th:field="${tool.inputSchema}"></textarea>
                <div class="form-text">请输入符合JSON Schema规范的输入定义</div>
                <div class="invalid-feedback" id="inputSchemaError"></div>
                <div class="valid-feedback">JSON Schema格式正确</div>
            </div>

            <div class="mb-3">
                <label class="form-label" for="outputSchema">输出Schema (JSON格式) <span
                        class="required">*</span></label>
                <textarea class="form-control json-editor" id="outputSchema"
                          placeholder='{"type": "object", "properties": {...}}'
                          required rows="6"
                          th:field="${tool.outputSchema}"></textarea>
                <div class="form-text">请输入符合JSON Schema规范的输出定义</div>
                <div class="invalid-feedback" id="outputSchemaError"></div>
                <div class="valid-feedback">JSON Schema格式正确</div>
            </div>
        </div>

        <!-- 原始HTTP接口配置 -->
        <div class="form-section" th:if="${httpTool != null}">
            <h4 class="mb-3"><i class="fas fa-globe me-2"></i>原始HTTP接口配置</h4>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="httpToolName">工具名称</label>
                        <input class="form-control" id="httpToolName" th:value="${httpTool.nameDisplay}" type="text">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="httpToolDesc">工具描述</label>
                        <input class="form-control" id="httpToolDesc" th:value="${httpTool.descDisplay}" type="text">
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="httpToolUrl">请求URL</label>
                        <input class="form-control" id="httpToolUrl" th:value="${httpTool.reqUrl}" type="text">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="httpToolMethod">请求方法</label>
                        <select class="form-select" id="httpToolMethod" th:value="${httpTool.reqMethod}">
                            <option th:selected="${httpTool.reqMethod == 'GET'}" value="GET">GET</option>
                            <option th:selected="${httpTool.reqMethod == 'POST'}" value="POST">POST</option>
                            <option th:selected="${httpTool.reqMethod == 'PUT'}" value="PUT">PUT</option>
                            <option th:selected="${httpTool.reqMethod == 'DELETE'}" value="DELETE">DELETE</option>
                            <option th:selected="${httpTool.reqMethod == 'PATCH'}" value="PATCH">PATCH</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label" for="httpToolHeaders">请求头（JSON格式）</label>
                <textarea class="form-control json-editor" id="httpToolHeaders" rows="3"
                          th:text="${httpTool.reqHeaders}"></textarea>
            </div>

            <div class="mb-3">
                <label class="form-label" for="httpToolInputSchema">输入Schema（JSON格式）</label>
                <textarea class="form-control json-editor" id="httpToolInputSchema" rows="4"
                          th:text="${httpTool.inputSchema}"></textarea>
            </div>

            <div class="mb-3">
                <label class="form-label" for="httpToolOutputSchema">输出Schema（JSON格式）</label>
                <textarea class="form-control json-editor" id="httpToolOutputSchema" rows="4"
                          th:text="${httpTool.outputSchema}"></textarea>
            </div>
        </div>

        <!-- HTTP转换模板配置 -->
        <div class="form-section" th:if="${httpConverter != null}">
            <h4 class="mb-3"><i class="fas fa-exchange-alt me-2"></i>HTTP转换模板配置</h4>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="converterReqUrl">请求URL模板（jinja2）</label>
                        <input class="form-control" id="converterReqUrl" th:value="${httpConverter.reqUrl}" type="text">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="converterReqMethod">请求方法</label>
                        <select class="form-select" id="converterReqMethod" th:value="${httpConverter.reqMethod}">
                            <option th:selected="${httpConverter.reqMethod == 'GET'}" value="GET">GET</option>
                            <option th:selected="${httpConverter.reqMethod == 'POST'}" value="POST">POST</option>
                            <option th:selected="${httpConverter.reqMethod == 'PUT'}" value="PUT">PUT</option>
                            <option th:selected="${httpConverter.reqMethod == 'DELETE'}" value="DELETE">DELETE</option>
                            <option th:selected="${httpConverter.reqMethod == 'PATCH'}" value="PATCH">PATCH</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label" for="converterReqHeaders">请求头模板（jinja2）</label>
                <textarea class="form-control jinja2-field" id="converterReqHeaders" rows="3"
                          th:text="${httpConverter.reqHeaders}"></textarea>
                <div class="form-text">支持Jinja2变量: {{ variable }}</div>
                <div class="invalid-feedback" id="converterReqHeadersError"></div>
                <div class="valid-feedback">Jinja2语法正确</div>
            </div>

            <div class="mb-3">
                <label class="form-label" for="converterReqBody">请求体模板（jinja2）</label>
                <textarea class="form-control jinja2-field" id="converterReqBody" rows="3"
                          th:text="${httpConverter.reqBody}"></textarea>
                <div class="form-text">支持Jinja2变量: {{ variable }}</div>
                <div class="invalid-feedback" id="converterReqBodyError"></div>
                <div class="valid-feedback">Jinja2语法正确</div>
            </div>

            <div class="mb-3">
                <label class="form-label" for="converterRespBody">响应体模板（jinja2）</label>
                <textarea class="form-control jinja2-field" id="converterRespBody" rows="3"
                          th:text="${httpConverter.respBody}"></textarea>
                <div class="form-text">支持Jinja2变量: {{ variable }}</div>
                <div class="invalid-feedback" id="converterRespBodyError"></div>
                <div class="valid-feedback">Jinja2语法正确</div>
            </div>
        </div>

        <!-- Expo转换模板配置 -->
        <div class="form-section" th:if="${expoConverter != null}">
            <h4 class="mb-3"><i class="fas fa-exchange-alt me-2"></i>Expo转换模板配置</h4>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="expoAppClass">App Class</label>
                        <input class="form-control" id="expoAppClass" th:value="${expoConverter.appClass}"
                               type="number">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label" for="expoCommandId">Command ID</label>
                        <input class="form-control" id="expoCommandId" th:value="${expoConverter.commandId}"
                               type="number">
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label" for="expoInputArgs">输入参数模板（jinja2）</label>
                <textarea class="form-control jinja2-field" id="expoInputArgs" rows="3"
                          th:text="${expoConverter.inputArgs}"></textarea>
                <div class="form-text">支持Jinja2变量: {{ variable }}</div>
                <div class="invalid-feedback" id="expoInputArgsError"></div>
                <div class="valid-feedback">Jinja2语法正确</div>
            </div>

            <div class="mb-3">
                <label class="form-label" for="expoOutputArgs">输出参数模板（jinja2）</label>
                <textarea class="form-control jinja2-field" id="expoOutputArgs" rows="3"
                          th:text="${expoConverter.outputArgs}"></textarea>
                <div class="form-text">支持Jinja2变量: {{ variable }}</div>
                <div class="invalid-feedback" id="expoOutputArgsError"></div>
                <div class="valid-feedback">Jinja2语法正确</div>
            </div>
        </div>

        <!-- Missing data warnings - HTTP type (仅提示缺少原始接口) -->
        <div class="alert alert-warning d-flex justify-content-between align-items-center"
             th:if="${tool.convertType != null and (tool.convertType == '1' or tool.convertType.toLowerCase().contains('http')) and httpTool == null}">
            <div>
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>提示:</strong> 该MCP工具缺少关联的原始HTTP接口信息。
            </div>
            <a class="btn btn-sm btn-primary" href="/origin-http-tools/new"
               th:href="@{/origin-http-tools/new(toolNum=${tool.toolNum})}">
                <i class="fas fa-plus me-1"></i>添加原始HTTP接口
            </a>
        </div>

        <!-- Missing data warnings - Expo type (仅提示缺少原始接口) -->
        <div class="alert alert-warning d-flex justify-content-between align-items-center"
             th:if="${tool.convertType != null and (tool.convertType == '2' or tool.convertType.equalsIgnoreCase('expo')) and expoTool == null}">
            <div>
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>提示:</strong> 该MCP工具缺少关联的原始Expo接口信息。
            </div>
            <a class="btn btn-sm btn-primary" href="/origin-expo-tools/new"
               th:href="@{/origin-expo-tools/new(toolNum=${tool.toolNum})}">
                <i class="fas fa-plus me-1"></i>添加Expo接口
            </a>
        </div>

        <!-- Missing data warnings - Code type -->
        <div class="alert alert-info"
             th:if="${tool.convertType != null and (tool.convertType == '3' or tool.convertType.equalsIgnoreCase('manul'))}">
            <i class="fas fa-info-circle me-2"></i>
            <strong>提示:</strong> 该MCP工具使用手动转换模板,直接通过代码实现,无需额外的转换器配置。
        </div>

        <!-- Missing data warnings - Unknown type or missing convertType -->
        <div class="alert alert-warning"
             th:if="${tool.convertType == null or (tool.convertType != '1' and tool.convertType != '2' and tool.convertType != '3' and !tool.convertType.toLowerCase().contains('http') and !tool.convertType.equalsIgnoreCase('expo') and !tool.convertType.equalsIgnoreCase('manul'))}">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>提示:</strong> 该MCP工具的转换模板类型未设置或无效,请检查convertType字段。
        </div>

        <!-- 提交按钮 -->
        <div class="d-flex justify-content-end gap-2">
            <a class="btn btn-secondary" href="/mcp-tools">
                <i class="fas fa-times me-2"></i>取消
            </a>
            <button class="btn btn-success" type="submit">
                <i class="fas fa-save me-2"></i>保存工具
            </button>
        </div>
    </form>
</div>

<script src="/vendor/bootstrap/bootstrap-5.3.0.bundle.min.js"></script>
<script>
    // 合并多语言字段为JSON格式
    function mergeMultilingualField(enText, zhText) {
        const data = {
            en: enText.trim(),
            zh: zhText.trim()
        };
        return JSON.stringify(data);
    }

    // JSON Schema验证函数
    function validateJsonSchema(schemaText) {
        if (!schemaText || schemaText.trim() === '') {
            return {valid: false, error: '不能为空'};
        }

        try {
            const schema = JSON.parse(schemaText);

            if (typeof schema !== 'object' || schema === null) {
                return {valid: false, error: 'JSON Schema必须是一个对象'};
            }

            if (!schema.type) {
                return {valid: false, error: '缺少必需的"type"字段'};
            }

            const validTypes = ['object', 'array', 'string', 'number', 'integer', 'boolean', 'null'];
            if (!validTypes.includes(schema.type)) {
                return {valid: false, error: `无效的type值: ${schema.type}`};
            }

            return {valid: true, error: null};
        } catch (e) {
            return {valid: false, error: `JSON格式错误: ${e.message}`};
        }
    }

    // Jinja2模板验证函数
    function validateJinja2Template(template) {
        if (!template || template.trim() === '') {
            return {valid: false, error: '不能为空'};
        }

        const errors = [];

        // 检查 {{ }} 是否匹配
        const varMatches = template.match(/\{\{/g);
        const varCloses = template.match(/\}\}/g);
        if (varMatches && varCloses && varMatches.length !== varCloses.length) {
            errors.push('变量标签{{ }}未正确闭合');
        } else if ((varMatches && !varCloses) || (!varMatches && varCloses)) {
            errors.push('变量标签{{ }}未正确闭合');
        }

        // 检查 {% %} 是否匹配
        const stmtMatches = template.match(/\{%/g);
        const stmtCloses = template.match(/%\}/g);
        if (stmtMatches && stmtCloses && stmtMatches.length !== stmtCloses.length) {
            errors.push('语句标签{% %}未正确闭合');
        } else if ((stmtMatches && !stmtCloses) || (!stmtMatches && stmtCloses)) {
            errors.push('语句标签{% %}未正确闭合');
        }

        // 检查 if/endif 配对
        const ifCount = (template.match(/\{%\s*if\s+/g) || []).length;
        const endifCount = (template.match(/\{%\s*endif\s*%\}/g) || []).length;
        if (ifCount !== endifCount) {
            errors.push('if语句缺少对应的endif');
        }

        // 检查 for/endfor 配对
        const forCount = (template.match(/\{%\s*for\s+/g) || []).length;
        const endforCount = (template.match(/\{%\s*endfor\s*%\}/g) || []).length;
        if (forCount !== endforCount) {
            errors.push('for循环缺少对应的endfor');
        }

        if (errors.length > 0) {
            return {valid: false, error: errors.join('; ')};
        }

        return {valid: true, error: null};
    }

    // 为字段添加实时验证
    function addRealTimeValidation(fieldId, validatorFn) {
        const field = document.getElementById(fieldId);
        const errorDiv = document.getElementById(fieldId + 'Error');

        if (!field) return;

        // 失焦时验证
        field.addEventListener('blur', function () {
            const result = validatorFn(this.value);

            if (result.valid) {
                field.classList.remove('is-invalid');
                field.classList.add('is-valid');
                if (errorDiv) errorDiv.textContent = '';
            } else {
                field.classList.remove('is-valid');
                field.classList.add('is-invalid');
                if (errorDiv) errorDiv.textContent = result.error;
            }
        });

        // 输入时实时反馈(如果已经标记为错误)
        field.addEventListener('input', function () {
            if (this.classList.contains('is-invalid') && this.value.trim() !== '') {
                const result = validatorFn(this.value);
                if (result.valid) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                    if (errorDiv) errorDiv.textContent = '';
                }
            }
        });
    }

    // 解析多语言JSON字段
    function parseMultilingualField(jsonStr) {
        try {
            const data = JSON.parse(jsonStr);
            return {
                en: data.en || '',
                zh: data.zh || ''
            };
        } catch (e) {
            return {en: '', zh: ''};
        }
    }

    // 表单验证
    document.getElementById('mcpToolForm').addEventListener('submit', function (e) {
        e.preventDefault();

        // 合并多语言字段
        const nameEn = document.getElementById('nameDisplayEn').value;
        const nameZh = document.getElementById('nameDisplayZh').value;
        const descEn = document.getElementById('descriptionDisplayEn').value;
        const descZh = document.getElementById('descriptionDisplayZh').value;

        // 设置隐藏字段值
        document.getElementById('nameDisplay').value = mergeMultilingualField(nameEn, nameZh);
        document.getElementById('descriptionDisplay').value = mergeMultilingualField(descEn, descZh);

        // 验证JSON格式
        const jsonFields = ['inputSchema', 'outputSchema'];
        for (let field of jsonFields) {
            const element = document.getElementById(field);
            if (element.value.trim()) {
                try {
                    JSON.parse(element.value);
                } catch (error) {
                    alert(`${field} 字段的JSON格式不正确: ${error.message}`);
                    element.focus();
                    return;
                }
            }
        }

        // 发送AJAX请求
        const formData = new FormData(this);
        const jsonData = {};

        // 转换FormData为JSON
        for (let [key, value] of formData.entries()) {
            jsonData[key] = value;
        }

        // 收集原始HTTP接口数据
        const httpToolData = {};
        const httpToolFields = ['httpToolName', 'httpToolDesc', 'httpToolUrl', 'httpToolMethod', 'httpToolHeaders', 'httpToolInputSchema', 'httpToolOutputSchema'];
        httpToolFields.forEach(field => {
            const element = document.getElementById(field);
            if (element) {
                let fieldName = field.replace('httpTool', '').toLowerCase();
                if (fieldName === 'name') fieldName = 'nameDisplay';
                else if (fieldName === 'desc') fieldName = 'descDisplay';
                else if (fieldName === 'url') fieldName = 'reqUrl';
                else if (fieldName === 'method') fieldName = 'reqMethod';
                else if (fieldName === 'headers') fieldName = 'reqHeaders';
                else if (fieldName === 'inputschema') fieldName = 'inputSchema';
                else if (fieldName === 'outputschema') fieldName = 'outputSchema';
                httpToolData[fieldName] = element.value;
            }
        });

        // 收集转换器数据
        const converterData = {};
        const converterFields = ['converterReqUrl', 'converterReqMethod', 'converterReqHeaders', 'converterReqBody', 'converterRespBody'];
        converterFields.forEach(field => {
            const element = document.getElementById(field);
            if (element) {
                let fieldName = field.replace('converter', '').toLowerCase();
                if (fieldName === 'requrl') fieldName = 'reqUrl';
                else if (fieldName === 'reqmethod') fieldName = 'reqMethod';
                else if (fieldName === 'reqheaders') fieldName = 'reqHeaders';
                else if (fieldName === 'reqbody') fieldName = 'reqBody';
                else if (fieldName === 'respbody') fieldName = 'respBody';
                converterData[fieldName] = element.value;
            }
        });

        // 添加多表数据到请求
        if (Object.keys(httpToolData).length > 0) {
            jsonData.httpTool = httpToolData;
        }
        if (Object.keys(converterData).length > 0) {
            jsonData.converter = converterData;
        }

        fetch('/mcp-tools/api/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(jsonData)
        })
            .then(response => {
                if (response.ok) {
                    return response.text();
                } else {
                    return response.text().then(text => Promise.reject(text));
                }
            })
            .then(data => {
                alert('保存成功!');
                window.location.href = '/mcp-tools';
            })
            .catch(error => {
                alert('保存失败: ' + error);
            });
    });

    // JSON格式化
    function formatJson(fieldId) {
        const element = document.getElementById(fieldId);
        try {
            const json = JSON.parse(element.value);
            element.value = JSON.stringify(json, null, 2);
        } catch (error) {
            alert('JSON格式不正确: ' + error.message);
        }
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function () {
        // 为JSON编辑器添加格式化功能
        const jsonEditors = document.querySelectorAll('.json-editor');
        jsonEditors.forEach(editor => {
            editor.addEventListener('blur', function () {
                if (this.value.trim()) {
                    try {
                        const json = JSON.parse(this.value);
                        this.value = JSON.stringify(json, null, 2);
                    } catch (error) {
                        // 静默处理，不打断用户输入
                    }
                }
            });
        });

        // 初始化多语言字段
        const nameDisplayValue = document.getElementById('nameDisplay').value;
        const descriptionDisplayValue = document.getElementById('descriptionDisplay').value;

        if (nameDisplayValue) {
            const nameParsed = parseMultilingualField(nameDisplayValue);
            document.getElementById('nameDisplayEn').value = nameParsed.en;
            document.getElementById('nameDisplayZh').value = nameParsed.zh;
        }

        if (descriptionDisplayValue) {
            const descParsed = parseMultilingualField(descriptionDisplayValue);
            document.getElementById('descriptionDisplayEn').value = descParsed.en;
            document.getElementById('descriptionDisplayZh').value = descParsed.zh;
        }

        // 延迟初始化验证器,确保DOM完全加载
        setTimeout(() => {
            // JSON Schema验证
            addRealTimeValidation('inputSchema', validateJsonSchema);
            addRealTimeValidation('outputSchema', validateJsonSchema);

            // Jinja2模板验证
            addRealTimeValidation('converterReqHeaders', validateJinja2Template);
            addRealTimeValidation('converterReqBody', validateJinja2Template);
            addRealTimeValidation('converterRespBody', validateJinja2Template);
            addRealTimeValidation('expoInputArgs', validateJinja2Template);
            addRealTimeValidation('expoOutputArgs', validateJinja2Template);
        }, 1000);
    });
</script>
</body>
</html>